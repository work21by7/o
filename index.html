<!DOCTYPE html>
<html lang="en" dir="ltr" class="theme-obsidian">

<head>
    <meta charset="UTF-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <title>Titanium Clock: Infinity Edition</title>
    <meta name="application-name" content="Ti-Clock">
    <meta name="author" content="Titanium Dev Systems">
    <meta name="description"
        content="An enterprise-grade, high-performance flip clock and productivity timer featuring Picture-in-Picture mode and focus tools.">
    <meta name="keywords"
        content="clock, timer, stopwatch, pomodoro, focus, productivity, 3d, animation, pwa, javascript">
    <meta name="robots" content="index, follow">
    <meta name="google" content="notranslate">

    <meta name="theme-color" content="#000000">
    <meta name="color-scheme" content="dark light">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ti-Clock">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">

    <link rel="manifest" href="manifest.json">

    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âŒš</text></svg>">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link
        href="https://fonts.googleapis.com/css2?family=Oswald:wght@200;300;400;500;600;700&family=Roboto+Mono:wght@300;400;500;700&family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        /* * -------------------------------------------------------------------
             * 3.1 ROOT VARIABLE DEFINITIONS
             * Defines the global design language and tokens.
             * -------------------------------------------------------------------
             */
        :root {
            /* --- DIMENSIONS & SPACING --- */
            --dim-gap-base: 2vh;
            --dim-gap-wide: 4vw;

            --dim-radius-xs: 4px;
            --dim-radius-sm: 8px;
            --dim-radius-md: 12px;
            --dim-radius-lg: 16px;
            --dim-radius-xl: 24px;
            --dim-radius-btn: 50px;
            --dim-radius-modal: 16px;
            --dim-radius-full: 9999px;
            --dim-radius-card: 12px;

            /* --- TYPOGRAPHY STACKS --- */
            --font-stack-display: 'Oswald', sans-serif;
            --font-stack-ui: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-stack-mono: 'Roboto Mono', monospace;

            /* --- ANIMATION PHYSICS --- */
            --anim-time-flip: 600ms;
            --anim-time-ui: 250ms;
            --anim-time-page: 500ms;

            --anim-ease-bounce: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --anim-ease-smooth: cubic-bezier(0.4, 0.0, 0.2, 1);
            --anim-ease-snap: cubic-bezier(0.68, -0.55, 0.265, 1.55);

            /* --- 3D RENDERING --- */
            --render-perspective: 1200px;
            --render-origin-x: 50%;
            --render-origin-y: 90%;

            /* --- LAYOUT CALCULATIONS --- */
            /* Standard Portrait Mode Defaults */
            --layout-card-width: min(85vw, 65vh);
            --layout-card-height: 42vh;
            --layout-font-size: min(38vh, 45vw);

            --layout-mini-size-w: 80px;
            --layout-mini-size-h: 100px;
            --layout-mini-font: 50px;
        }

        /* * -------------------------------------------------------------------
             * 3.2 THEME ENGINE
             * Explicit color definitions for all supported themes.
             * -------------------------------------------------------------------
             */

        /* THEME: OBSIDIAN (Default Dark Mode) */
        :root.theme-obsidian {
            --color-bg-app: #050505;
            --color-bg-panel: #111111;
            --color-bg-surface: #1a1a1a;
            --color-bg-overlay: rgba(0, 0, 0, 0.85);

            --color-card-body: #151515;
            --color-card-face: #1e1e1e;

            --color-text-primary: #e0e0e0;
            --color-text-secondary: #888888;
            --color-text-inverse: #000000;
            --color-text-debug: #00ff00;

            --color-brand-primary: #ffffff;
            --color-brand-accent: #ff9800;
            /* Amber */
            --color-state-success: #2ed573;
            --color-state-danger: #ff4757;
            --color-state-info: #3742fa;

            --color-border-subtle: #333333;
            --color-border-strong: #555555;

            --effect-particle-fill: rgba(255, 255, 255, 0.15);
            --effect-shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.5);
            --effect-shadow-hard: 0 20px 60px rgba(0, 0, 0, 0.8);
        }

        /* THEME: POLAR (High Contrast Light Mode) */
        :root.theme-polar {
            --color-bg-app: #f5f7fa;
            --color-bg-panel: #ffffff;
            --color-bg-surface: #e4e7eb;
            --color-bg-overlay: rgba(255, 255, 255, 0.85);

            --color-card-body: #ffffff;
            --color-card-face: #f1f3f5;

            --color-text-primary: #2d3436;
            --color-text-secondary: #636e72;
            --color-text-inverse: #ffffff;
            --color-text-debug: #000000;

            --color-brand-primary: #0984e3;
            --color-brand-accent: #00cec9;
            /* Teal */
            --color-state-success: #00b894;
            --color-state-danger: #d63031;
            --color-state-info: #74b9ff;

            --color-border-subtle: #dfe6e9;
            --color-border-strong: #b2bec3;

            --effect-particle-fill: rgba(0, 0, 0, 0.1);
            --effect-shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.1);
            --effect-shadow-hard: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        /* THEME: CYBERPUNK (Neon / Night Mode) */
        :root.theme-cyberpunk {
            --color-bg-app: #0b001a;
            --color-bg-panel: #18002e;
            --color-bg-surface: #240046;
            --color-bg-overlay: rgba(11, 0, 26, 0.9);

            --color-card-body: #120024;
            --color-card-face: #2a004f;

            --color-text-primary: #ff00ff;
            /* Magenta */
            --color-text-secondary: #bc13fe;
            --color-text-inverse: #000000;
            --color-text-debug: #00ff00;

            --color-brand-primary: #00f2ff;
            /* Cyan */
            --color-brand-accent: #ffe600;
            /* Yellow */
            --color-state-success: #00ff00;
            --color-state-danger: #ff0055;
            --color-state-info: #00f2ff;

            --color-border-subtle: #52007a;
            --color-border-strong: #8a00c2;

            --effect-particle-fill: rgba(255, 0, 255, 0.4);
            --effect-shadow-soft: 0 0 20px rgba(255, 0, 255, 0.2);
            --effect-shadow-hard: 0 0 40px rgba(0, 242, 255, 0.3);
        }

        /* THEME: FOREST (Organic / Nature) */
        :root.theme-forest {
            --color-bg-app: #0c1a12;
            --color-bg-panel: #142b1e;
            --color-bg-surface: #1e3b2b;
            --color-bg-overlay: rgba(12, 26, 18, 0.9);

            --color-card-body: #11261b;
            --color-card-face: #1a3829;

            --color-text-primary: #d4edda;
            --color-text-secondary: #8fa394;
            --color-text-inverse: #000000;
            --color-text-debug: #ffffff;

            --color-brand-primary: #4ade80;
            /* Light Green */
            --color-brand-accent: #facc15;
            /* Gold */
            --color-state-success: #86efac;
            --color-state-danger: #fca5a5;
            --color-state-info: #7dd3fc;

            --color-border-subtle: #2d523e;
            --color-border-strong: #40775a;

            --effect-particle-fill: rgba(74, 222, 128, 0.2);
            --effect-shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.6);
            --effect-shadow-hard: 0 20px 60px rgba(0, 0, 0, 0.8);
        }

        /* * -------------------------------------------------------------------
             * 3.3 GLOBAL RESET & BASE STYLES
             * Normalizes rendering across all browser engines.
             * -------------------------------------------------------------------
             */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin-top: 0;
            margin-right: 0;
            margin-bottom: 0;
            margin-left: 0;
            padding-top: 0;
            padding-right: 0;
            padding-bottom: 0;
            padding-left: 0;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html {
            font-size: 16px;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            background-color: var(--color-bg-app);
            color: var(--color-text-primary);
            font-family: var(--font-stack-display);

            height: 100vh;
            width: 100vw;

            overflow-x: hidden;
            overflow-y: hidden;

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;

            user-select: none;
            position: relative;

            transition-property: background-color, color;
            transition-duration: 0.6s;
            transition-timing-function: var(--anim-ease-smooth);
            transition-delay: 0s;
        }

        /* Canvas layer for particle effects */
        #particleCanvas {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            opacity: 0.6;
        }

        /* * -------------------------------------------------------------------
             * 3.4 LAYOUT MODIFIERS
             * Handles Landscape and Uniform Layout modes via CSS Variables.
             * -------------------------------------------------------------------
             */

        /* State: Landscape Mode */
        body.mode-landscape {
            --layout-card-height: 70vh;
            --layout-card-width: 45vw;
            --layout-font-size: min(55vh, 30vw);
            --dim-gap-base: 4vw;

            flex-direction: row;
        }

        /* State: Uniform Mode (All cards equal size) */
        body.layout-uniform {
            --layout-card-height: 26vh;
            --layout-font-size: min(22vh, 45vw);
        }

        /* Combination State: Landscape + Uniform */
        body.mode-landscape.layout-uniform {
            --layout-card-width: 30vw;
            --layout-card-height: 60vh;
            --layout-font-size: min(45vh, 20vw);
        }

        /* * -------------------------------------------------------------------
             * 3.5 COMPONENT: HEADER REGION
             * Contains Date, Streak Counter, and Status Badges.
             * -------------------------------------------------------------------
             */
        .region-header {
            position: absolute;
            top: 24px;
            left: 24px;
            z-index: 100;

            display: flex;
            flex-direction: column;
            gap: 12px;

            pointer-events: none;
        }

        .widget-date {
            font-family: var(--font-stack-mono);
            font-size: 14px;
            letter-spacing: 2px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            font-weight: 700;

            display: flex;
            align-items: center;
            gap: 10px;
        }

        .widget-date svg {
            width: 16px;
            height: 16px;
            opacity: 0.7;
            display: block;
        }

        .badge-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;

            font-family: var(--font-stack-ui);
            font-size: 13px;
            font-weight: 600;

            padding-top: 8px;
            padding-bottom: 8px;
            padding-left: 16px;
            padding-right: 16px;

            border-top-left-radius: var(--dim-radius-btn);
            border-top-right-radius: var(--dim-radius-btn);
            border-bottom-right-radius: var(--dim-radius-btn);
            border-bottom-left-radius: var(--dim-radius-btn);

            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);

            pointer-events: auto;

            border-width: 1px;
            border-style: solid;
            border-color: transparent;

            transition-property: all;
            transition-duration: 0.3s;
            transition-timing-function: var(--anim-ease-smooth);
        }

        /* Badge Variant: Streak */
        .badge-status.variant-streak {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--color-brand-accent);
            border-color: rgba(255, 152, 0, 0.2);
        }

        /* Badge Variant: Focus */
        .badge-status.variant-focus {
            background-color: rgba(255, 71, 87, 0.1);
            color: var(--color-state-danger);
            border-color: rgba(255, 71, 87, 0.3);
        }

        /* Badge Variant: Break */
        .badge-status.variant-break {
            background-color: rgba(46, 213, 115, 0.1);
            color: var(--color-state-success);
            border-color: rgba(46, 213, 115, 0.3);
        }

        /* * -------------------------------------------------------------------
             * 3.6 COMPONENT: NAVIGATION BAR
             * Top-right control center for modes and tools.
             * -------------------------------------------------------------------
             */
        .region-hud {
            position: absolute;
            top: 24px;
            right: 24px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
            pointer-events: none;
        }

        .widget-battery {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 16px;
            border-radius: var(--dim-radius-btn);
            border: 1px solid var(--color-border-subtle);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            font-family: var(--font-stack-mono);
            font-size: 12px;
            font-weight: 700;
            color: var(--color-text-secondary);
            pointer-events: auto;
            box-shadow: var(--effect-shadow-soft);
            transition: all 0.3s ease;
        }

        .widget-battery:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-text-primary);
            border-color: var(--color-border-strong);
        }

        .battery-bar-container {
            width: 28px;
            height: 14px;
            border: 1.5px solid currentColor;
            border-radius: 3px;
            position: relative;
            padding: 1.5px;
            opacity: 0.8;
        }

        .battery-bar-container::after {
            content: '';
            position: absolute;
            right: -4px;
            top: 3px;
            width: 2.5px;
            height: 5px;
            background: currentColor;
            border-radius: 0 1px 1px 0;
        }

        .battery-level {
            height: 100%;
            background: var(--color-state-success);
            width: 0%;
            border-radius: 1px;
            transition: width 0.5s var(--anim-ease-smooth), background 0.5s ease;
        }

        .region-nav {
            position: relative;
            z-index: 100;

            display: flex;
            gap: 8px;
            align-items: center;

            background-color: rgba(0, 0, 0, 0.3);

            padding-top: 6px;
            padding-bottom: 6px;
            padding-left: 6px;
            padding-right: 6px;

            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            border-bottom-right-radius: 16px;
            border-bottom-left-radius: 16px;

            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);

            border-width: 1px;
            border-style: solid;
            border-color: rgba(255, 255, 255, 0.08);

            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .btn-nav {
            background-color: transparent;
            border-width: 0;
            border-style: none;
            color: var(--color-text-secondary);

            font-family: var(--font-stack-display);
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;

            padding-top: 8px;
            padding-bottom: 8px;
            padding-left: 14px;
            padding-right: 14px;

            border-radius: 10px;

            transition-property: all;
            transition-duration: 0.2s;
            transition-timing-function: ease;
        }

        .btn-nav:hover {
            color: var(--color-text-primary);
            background-color: rgba(255, 255, 255, 0.05);
        }

        .btn-nav.active {
            color: var(--color-bg-app);
            background-color: var(--color-brand-primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .nav-links,
        .nav-utils {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        #btnMore {
            display: none;
        }

        .divider-vertical {
            width: 1px;
            height: 20px;
            background-color: var(--color-border-subtle);
            margin-left: 6px;
            margin-right: 6px;
        }

        .btn-icon {
            background-color: transparent;
            border-width: 1px;
            border-style: solid;
            border-color: transparent;
            color: var(--color-text-primary);

            width: 38px;
            height: 38px;
            border-radius: 10px;
            cursor: pointer;

            display: flex;
            align-items: center;
            justify-content: center;

            transition-property: all;
            transition-duration: 0.2s;
            transition-timing-function: ease;
        }

        .btn-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .btn-icon:active {
            transform: scale(0.95);
        }

        .btn-icon svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        #installBtn {
            display: none;
            color: var(--color-brand-accent);
            border-color: rgba(255, 152, 0, 0.3);
        }

        /* * -------------------------------------------------------------------
             * 3.7 COMPONENT: CLOCK STAGE
             * 3D Scene Container
             * -------------------------------------------------------------------
             */
        .region-stage {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;

            width: 100%;
            height: 100%;
            gap: var(--dim-gap-base);

            perspective: var(--render-perspective);
            perspective-origin: var(--render-origin-x) var(--render-origin-y);

            transition-property: gap;
            transition-duration: 0.4s;
            transition-timing-function: var(--anim-ease-smooth);

            z-index: 10;
        }

        .page-view {
            display: none;
            width: 100%;
            height: 100%;
            padding: 120px 40px 60px;
            overflow-y: auto;
            z-index: 20;
            animation: kf-page-in var(--anim-time-page) var(--anim-ease-smooth) forwards;
        }

        @keyframes kf-page-in {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page-view.state-active {
            display: block;
        }

        .ledger-container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--color-bg-panel);
            border-radius: var(--dim-radius-xl);
            border: 1px solid var(--color-border-subtle);
            padding: 40px;
            box-shadow: var(--effect-shadow-hard);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .ledger-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--color-border-subtle);
        }

        .ledger-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 32px;
        }

        .ledger-chart {
            height: 180px;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            align-items: flex-end;
            gap: 12px;
            padding: 24px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--dim-radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        .chart-bar {
            background: linear-gradient(to top, var(--color-brand-primary), var(--color-brand-accent));
            border-radius: 6px 6px 2px 2px;
            position: relative;
            min-height: 4px;
            transition: all 0.4s var(--anim-ease-bounce);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .chart-bar:hover {
            filter: brightness(1.2);
            transform: scaleX(1.05);
        }

        .chart-bar:hover::after {
            content: attr(data-label);
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-bg-surface);
            color: var(--color-text-primary);
            padding: 4px 8px;
            border-radius: var(--dim-radius-xs);
            font-family: var(--font-stack-mono);
            font-size: 11px;
            font-weight: 700;
            white-space: nowrap;
            box-shadow: var(--effect-shadow-soft);
            border: 1px solid var(--color-border-subtle);
            z-index: 10;
        }

        .ledger-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 8px;
        }

        .ledger-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: var(--dim-radius-md);
            border: 1px solid transparent;
            font-family: var(--font-stack-mono);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .ledger-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--color-border-subtle);
            transform: translateX(4px);
        }

        .ledger-item .type-focus {
            color: var(--color-state-danger);
            font-weight: 700;
        }

        .ledger-item .type-break {
            color: var(--color-state-success);
            font-weight: 700;
        }

        .timezone-selector {
            background: var(--color-bg-surface);
            border: 1px solid var(--color-border-strong);
            color: var(--color-text-primary);
            padding: 10px 20px;
            border-radius: var(--dim-radius-btn);
            font-family: var(--font-stack-ui);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 45px;
        }

        .timezone-selector:hover {
            border-color: var(--color-brand-primary);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }

        .world-clock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 24px;
            margin-top: 32px;
        }

        .world-clock-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.01) 100%);
            border: 1px solid var(--color-border-subtle);
            border-radius: var(--dim-radius-lg);
            padding: 24px;
            text-align: center;
            transition: all 0.3s var(--anim-ease-smooth);
        }

        .world-clock-card:hover {
            transform: translateY(-5px);
            border-color: var(--color-border-strong);
            background: rgba(255, 255, 255, 0.06);
        }

        .world-clock-time {
            font-family: var(--font-stack-mono);
            font-size: 32px;
            font-weight: 700;
            margin: 12px 0;
            color: var(--color-brand-primary);
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }

        .world-clock-label {
            font-family: var(--font-stack-display);
            font-size: 14px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }

        body.mode-landscape .region-stage {
            flex-direction: row;
        }

        /* * -------------------------------------------------------------------
             * 3.8 COMPONENT: FLIP CARDS & PHYSICS
             * The core mechanical simulation components.
             * -------------------------------------------------------------------
             */
        .comp-card {
            position: relative;
            background-color: var(--color-card-body);
            border-radius: var(--dim-radius-card);
            text-align: center;
            transform-style: preserve-3d;
            box-shadow: var(--effect-shadow-hard);

            transition-property: all;
            transition-duration: 0.5s;
            transition-timing-function: var(--anim-ease-smooth);
        }

        /* Variant: Standard Large */
        .comp-card.size-large {
            width: var(--layout-card-width);
            height: var(--layout-card-height);
        }

        .comp-card.size-large .text-digit {
            font-size: var(--layout-font-size);
            line-height: var(--layout-card-height);
            letter-spacing: -6px;
        }

        /* Variant: Standard Mini (Seconds) */
        .comp-card.size-mini {
            position: absolute;
            bottom: 40px;
            right: 40px;
            width: var(--layout-mini-size-w);
            height: var(--layout-mini-size-h);

            border-radius: var(--dim-radius-sm);
            z-index: 50;

            background-color: var(--color-bg-panel);

            border-width: 1px;
            border-style: solid;
            border-color: var(--color-border-subtle);
        }

        .comp-card.size-mini .text-digit {
            font-size: var(--layout-mini-font);
            line-height: var(--layout-mini-size-h);
            letter-spacing: -2px;
        }

        /* Uniform Overrides */
        body.layout-uniform .comp-card.size-mini {
            position: relative;
            bottom: auto;
            right: auto;
            width: var(--layout-card-width);
            height: var(--layout-card-height);
            background-color: var(--color-card-body);
            border-width: 0;
        }

        body.layout-uniform .comp-card.size-mini .text-digit {
            font-size: var(--layout-font-size);
            line-height: var(--layout-card-height);
            letter-spacing: -6px;
        }

        /* Internal Layers */
        .layer-face {
            position: absolute;
            left: 0;
            width: 100%;
            height: 50%;
            overflow: hidden;
            background-color: var(--color-card-face);
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        /* Card Seam */
        .comp-card::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #000;
            z-index: 10;
            transform: translateY(-50%);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
        }

        .text-digit {
            position: absolute;
            left: 0;
            width: 100%;
            height: 200%;
            display: block;
            text-align: center;
            color: var(--color-text-primary);
            font-weight: 700;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        /* Face: Top */
        .layer-face.pos-top {
            top: 0;
            border-top-left-radius: var(--dim-radius-card);
            border-top-right-radius: var(--dim-radius-card);
            transform-origin: bottom;
            z-index: 1;
            background: linear-gradient(to bottom, var(--color-bg-surface) 0%, var(--color-card-face) 100%);
        }

        .layer-face.pos-top .text-digit {
            top: 0;
        }

        /* Face: Bottom */
        .layer-face.pos-bottom {
            bottom: 0;
            border-bottom-left-radius: var(--dim-radius-card);
            border-bottom-right-radius: var(--dim-radius-card);
            transform-origin: top;
            z-index: 0;
            background: linear-gradient(to top, var(--color-bg-surface) 0%, var(--color-card-face) 100%);
        }

        .layer-face.pos-bottom .text-digit {
            top: -100%;
        }

        /* Animation Flaps */
        .layer-flap {
            z-index: 2;
            transform-style: preserve-3d;
            will-change: transform;
        }

        .layer-flap.pos-bottom {
            transform: rotateX(90deg);
        }

        /* Keyframes */
        .anim-flip-down {
            animation: kf-flip-down var(--anim-time-flip) ease-in forwards;
        }

        .anim-flip-up {
            animation: kf-flip-up var(--anim-time-flip) ease-out forwards;
        }

        @keyframes kf-flip-down {
            0% {
                transform: rotateX(0deg);
                filter: brightness(100%);
            }

            100% {
                transform: rotateX(-90deg);
                filter: brightness(30%);
            }
        }

        @keyframes kf-flip-up {
            0% {
                transform: rotateX(90deg);
                filter: brightness(30%);
            }

            100% {
                transform: rotateX(0deg);
                filter: brightness(100%);
            }
        }

        .label-meridiem {
            position: absolute;
            bottom: 10%;
            left: 8%;
            font-family: var(--font-stack-mono);
            font-size: 24px;
            font-weight: 700;
            color: var(--color-text-secondary);
            opacity: 0.6;
            z-index: 20;
        }

        /* * -------------------------------------------------------------------
             * 3.9 COMPONENT: MODAL SYSTEM
             * Overlay system for settings and help.
             * -------------------------------------------------------------------
             */
        .wrapper-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-bg-overlay);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 500;

            display: flex;
            align-items: center;
            justify-content: center;

            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .wrapper-modal.state-visible {
            opacity: 1;
            pointer-events: auto;
        }

        .comp-modal {
            background-color: var(--color-bg-panel);
            width: 380px;
            max-width: 90vw;

            border-radius: var(--dim-radius-modal);
            border-width: 1px;
            border-style: solid;
            border-color: var(--color-border-subtle);

            padding-top: 24px;
            padding-bottom: 24px;
            padding-left: 24px;
            padding-right: 24px;

            transform: scale(0.9);
            transition: transform 0.3s var(--anim-ease-bounce);
            box-shadow: var(--effect-shadow-hard);
        }

        .wrapper-modal.state-visible .comp-modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;

            border-bottom-width: 1px;
            border-bottom-style: solid;
            border-bottom-color: var(--color-border-subtle);
        }

        .modal-title {
            font-family: var(--font-stack-ui);
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-top: 0;
            margin-bottom: 0;
        }

        .modal-body-section {
            margin-bottom: 24px;
        }

        .label-section {
            display: block;
            font-family: var(--font-stack-mono);
            font-size: 11px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            margin-bottom: 12px;
            letter-spacing: 1px;
        }

        .layout-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .layout-grid-1 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .btn-option {
            background-color: var(--color-bg-surface);
            border-width: 1px;
            border-style: solid;
            border-color: var(--color-border-subtle);
            color: var(--color-text-secondary);

            padding-top: 14px;
            padding-bottom: 14px;

            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            font-family: var(--font-stack-ui);
            font-size: 13px;
            transition: all 0.2s;
        }

        .btn-option:hover {
            border-color: var(--color-text-primary);
            background-color: var(--color-bg-panel);
        }

        .btn-option.state-selected {
            background-color: var(--color-brand-primary);
            color: var(--color-bg-app);
            border-color: transparent;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .table-shortcuts {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--font-stack-ui);
            font-size: 13px;
        }

        .table-shortcuts td {
            padding-top: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--color-border-subtle);
            color: var(--color-text-secondary);
        }

        .table-shortcuts td:last-child {
            text-align: right;
            color: var(--color-text-primary);
            font-family: var(--font-stack-mono);
        }

        .table-shortcuts tr:last-child td {
            border-bottom: none;
        }

        .kbd-badge {
            background-color: var(--color-bg-surface);
            border: 1px solid var(--color-border-subtle);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        /* * -------------------------------------------------------------------
             * 3.10 COMPONENT: TOAST NOTIFICATIONS
             * -------------------------------------------------------------------
             */
        .popup-toast {
            position: fixed;
            top: 100px;
            right: 30px;

            background-color: var(--color-bg-panel);
            color: var(--color-text-primary);

            padding-top: 14px;
            padding-bottom: 14px;
            padding-left: 24px;
            padding-right: 24px;

            border-radius: 12px;

            border-left-width: 4px;
            border-left-style: solid;
            border-left-color: var(--color-brand-accent);

            box-shadow: var(--effect-shadow-soft);

            transform: translateX(50px);
            opacity: 0;
            transition: all 0.4s var(--anim-ease-bounce);

            font-family: var(--font-stack-ui);
            font-size: 13px;
            font-weight: 600;

            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            pointer-events: none;
        }

        .popup-toast.state-active {
            transform: translateX(0);
            opacity: 1;
        }

        /* * -------------------------------------------------------------------
             * 3.11 COMPONENT: BOTTOM ACTION BAR
             * -------------------------------------------------------------------
             */
        .region-footer {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);

            background-color: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);

            padding-top: 8px;
            padding-bottom: 8px;
            padding-left: 8px;
            padding-right: 8px;

            border-radius: 60px;

            border-width: 1px;
            border-style: solid;
            border-color: rgba(255, 255, 255, 0.1);

            display: none;
            gap: 10px;
            z-index: 200;
            box-shadow: var(--effect-shadow-hard);
        }

        .region-footer.state-visible {
            display: flex;
        }

        .btn-pill {
            height: 48px;

            padding-left: 32px;
            padding-right: 32px;

            border-radius: 24px;
            border-width: 0;
            border-style: none;

            background-color: transparent;
            color: #ffffff;

            font-family: var(--font-stack-ui);
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;

            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-pill:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .btn-pill.variant-primary {
            background-color: #ffffff;
            color: #000000;
        }

        .btn-pill.variant-primary:hover {
            background-color: #e0e0e0;
        }

        /* * -------------------------------------------------------------------
             * 3.12 COMPONENT: DEVELOPER HUD
             * -------------------------------------------------------------------
             */
        #devHud {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            background: rgba(0, 0, 0, 0.8);
            color: var(--color-text-debug);
            font-family: monospace;
            font-size: 10px;
            padding: 10px;
            z-index: 9999;
            display: none;
            border-bottom-right-radius: 10px;
            border: 1px solid var(--color-border-subtle);
        }

        .hud-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .hud-graph {
            width: 100%;
            height: 30px;
            background: #222;
            margin-top: 5px;
            position: relative;
        }

        .hud-bar {
            width: 2px;
            background: var(--color-text-debug);
            position: absolute;
            bottom: 0;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            :root {
                /* Shrink Clock */
                --layout-card-width: min(75vw, 55vh);
                --layout-card-height: 32vh;
                --layout-font-size: min(28vh, 35vw);
                --dim-gap-base: 1.5vh;
            }

            /* Shrink Top Nav & Scrollable */
            .region-nav {
                top: 16px !important;
                width: 94vw;
                max-width: none;
                overflow-x: auto;
                justify-content: flex-start;
                padding: 4px 8px;
                border-radius: 12px;
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            .region-nav::-webkit-scrollbar {
                display: none;
            }

            .btn-nav {
                font-size: 11px;
                padding: 6px 8px;
                flex-shrink: 0;
            }

            .btn-icon {
                width: 32px;
                height: 32px;
                flex-shrink: 0;
            }

            .btn-icon svg {
                width: 16px;
                height: 16px;
            }

            /* Compact Header (Date/Streak) */
            .region-header {
                top: 70px !important;
                left: 16px;
                scale: 0.9;
                transform-origin: top left;
            }

            /* Compact Footer (Start/Reset) */
            .region-footer {
                bottom: 24px;
                padding: 4px 6px;
            }

            .btn-pill {
                height: 38px;
                padding-left: 16px;
                padding-right: 16px;
                font-size: 12px;
            }

            /* Move Battery HUD below Nav */
            .region-hud {
                top: 70px;
                right: 16px;
            }

            .widget-battery {
                padding: 4px 8px;
                font-size: 10px;
            }

            /* Hide custom cursor on mobile */
            .cursor-dot,
            .cursor-outline {
                display: none !important;
            }
        }

        /* Mobile Portrait: Move Utility Icons to Bottom Left */
        @media (max-width: 768px) and (orientation: portrait) {

            /* Reset Main Nav Container to be transparent wrapper */
            .region-nav {
                transform: none !important;
                left: 0 !important;
                width: 100% !important;
                background: none !important;
                border: none !important;
                backdrop-filter: none !important;
                box-shadow: none !important;
                justify-content: center;
                top: 24px !important;
                overflow: visible !important;
            }

            /* Style the Links Bar (Top Center) */
            .nav-links {
                background: rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(16px);
                -webkit-backdrop-filter: blur(16px);
                border: 1px solid rgba(255, 255, 255, 0.08);
                border-radius: 12px;
                padding: 4px 8px;

                display: flex;
                gap: 4px;
                overflow-x: auto;
                -ms-overflow-style: none;
                scrollbar-width: none;
                max-width: 90vw;
            }

            .nav-links::-webkit-scrollbar {
                display: none;
            }

            /* Style the Utils Bar (Bottom Left) */
            .nav-utils {
                position: fixed;
                bottom: 30px;
                left: 24px;
                z-index: 300;

                /* Reset */
                background: transparent;
                backdrop-filter: none;
                -webkit-backdrop-filter: none;
                border: none;
                box-shadow: none;
                padding: 0;

                flex-direction: column-reverse;
                /* Expand upwards */
                align-items: flex-start;
            }

            #btnMore {
                display: flex;
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                width: 48px;
                height: 48px;
                border-radius: 50%;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }

            /* Hide other icons by default in portrait */
            .nav-utils .btn-icon:not(#btnMore) {
                display: none;
            }

            .nav-utils .divider-vertical {
                display: none;
            }

            /* Expanded State */
            .nav-utils.state-expanded {
                /* Container styles if needed */
            }

            .nav-utils.state-expanded .btn-icon:not(#btnMore) {
                display: flex;
                margin-bottom: 12px;
                /* Spacing between popped up items */
                background: rgba(20, 20, 20, 0.8);
                backdrop-filter: blur(16px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                width: 44px;
                height: 44px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);

                /* Animation */
                animation: kf-pop-up 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            }

            @keyframes kf-pop-up {
                from {
                    opacity: 0;
                    transform: translateY(10px) scale(0.8);
                }

                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }
        }

        /* Intro Overlay */
        #intro-shortcuts {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: kf-fade-out 0.5s ease 3s forwards;
        }

        @keyframes kf-fade-out {
            to {
                opacity: 0;
                visibility: hidden;
                pointer-events: none;
            }
        }

        .intro-content {
            background: var(--color-bg-panel);
            border: 1px solid var(--color-border-subtle);
            border-radius: var(--dim-radius-xl);
            padding: 40px;
            text-align: center;
            box-shadow: var(--effect-shadow-hard);
            transform: translateY(0);
            animation: kf-slide-up 0.5s ease-out;
        }

        @keyframes kf-slide-up {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .intro-title {
            font-family: var(--font-stack-display);
            font-size: 24px;
            margin-bottom: 24px;
            color: var(--color-brand-primary);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .intro-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px 32px;
            text-align: left;
        }

        .intro-row {
            font-family: var(--font-stack-ui);
            font-size: 14px;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .key {
            display: inline-block;
            background: var(--color-bg-surface);
            border: 1px solid var(--color-border-subtle);
            padding: 4px 10px;
            border-radius: 6px;
            font-family: var(--font-stack-mono);
            color: var(--color-text-primary);
            font-size: 12px;
            font-weight: 700;
            box-shadow: 0 2px 0 rgba(255, 255, 255, 0.1);
        }

        /* * -------------------------------------------------------------------
             * 3.13 COMPONENT: CUSTOM CURSOR
             * -------------------------------------------------------------------
             */
        body,
        button,
        a,
        input,
        select,
        textarea,
        .btn-nav,
        .btn-icon,
        .btn-pill,
        .timezone-selector {
            cursor: none !important;
        }

        .cursor-dot,
        .cursor-outline {
            position: fixed;
            top: 0;
            left: 0;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            z-index: 999999;
            /* Higher than alarm overlay */
            pointer-events: none;
        }

        .cursor-dot {
            width: 8px;
            height: 8px;
            background-color: var(--color-brand-primary);
            box-shadow: 0 0 10px var(--color-brand-primary);
        }

        .cursor-outline {
            width: 40px;
            height: 40px;
            border: 1px solid var(--color-text-secondary);
            transition: width 0.3s var(--anim-ease-bounce),
                height 0.3s var(--anim-ease-bounce),
                background-color 0.3s,
                border-color 0.3s;
        }

        /* Hover State */
        body.hovering .cursor-outline {
            width: 70px;
            height: 70px;
            background-color: rgba(255, 255, 255, 0.05);
            border-color: var(--color-brand-accent);
            border-width: 2px;
        }

        body.hovering .cursor-dot {
            background-color: var(--color-brand-accent);
            box-shadow: 0 0 15px var(--color-brand-accent);
        }

        /* Click State */
        body.clicking .cursor-outline {
            width: 30px;
            height: 30px;
            border-color: var(--color-state-success);
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* * -------------------------------------------------------------------
             * 3.14 COMPONENT: ALARM OVERLAY
             * -------------------------------------------------------------------
             */
        .alarm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .alarm-overlay.state-visible {
            opacity: 1;
            pointer-events: auto;
            animation: kf-alarm-bg 1s infinite alternate;
        }

        @keyframes kf-alarm-bg {
            from {
                background: rgba(220, 0, 0, 0.9);
            }

            to {
                background: rgba(100, 0, 0, 0.9);
            }
        }

        .alarm-content {
            text-align: center;
            animation: kf-shake 0.5s infinite;
        }

        @keyframes kf-shake {
            0% {
                transform: translate(1px, 1px) rotate(0deg);
            }

            10% {
                transform: translate(-1px, -2px) rotate(-1deg);
            }

            20% {
                transform: translate(-3px, 0px) rotate(1deg);
            }

            30% {
                transform: translate(3px, 2px) rotate(0deg);
            }

            40% {
                transform: translate(1px, -1px) rotate(1deg);
            }

            50% {
                transform: translate(-1px, 2px) rotate(-1deg);
            }

            60% {
                transform: translate(-3px, 1px) rotate(0deg);
            }

            70% {
                transform: translate(3px, 1px) rotate(-1deg);
            }

            80% {
                transform: translate(-1px, -1px) rotate(1deg);
            }

            90% {
                transform: translate(1px, 2px) rotate(0deg);
            }

            100% {
                transform: translate(1px, -2px) rotate(-1deg);
            }
        }

        .alarm-title {
            font-size: 50px;
            font-weight: 800;
            color: white;
            margin-bottom: 20px;
            text-transform: uppercase;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .btn-stop-alarm {
            font-size: 24px;
            padding: 20px 60px;
            background: white;
            color: #d63031;
            border: none;
            border-radius: 50px;
            font-weight: 900;
            cursor: none !important;
            /* Custom cursor */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s;
            text-transform: uppercase;
            letter-spacing: 2px;
            pointer-events: auto;
            /* Ensure clickable */
            z-index: 100000;
            /* Higher than overlay, lower than cursor */
        }

        .btn-stop-alarm:hover {
            transform: scale(1.1);
        }

        /* * -------------------------------------------------------------------
             * 3.15 COMPONENT: GLITCH OVERLAY
             * -------------------------------------------------------------------
             */
        .glitch-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 9999999;
            /* Topmost */
            display: none;
            overflow: hidden;
            pointer-events: none;
        }

        .glitch-overlay.state-active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .glitch-text {
            font-family: 'Courier New', monospace;
            font-size: 80px;
            font-weight: bold;
            color: white;
            position: relative;
            text-transform: uppercase;
        }

        .glitch-text::before,
        .glitch-text::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
        }

        .glitch-text::before {
            left: 2px;
            text-shadow: -2px 0 #ff00c1;
            clip: rect(44px, 450px, 56px, 0);
            animation: kf-glitch-anim 5s infinite linear alternate-reverse;
        }

        .glitch-text::after {
            left: -2px;
            text-shadow: -2px 0 #00fff9;
            clip: rect(44px, 450px, 56px, 0);
            animation: kf-glitch-anim2 5s infinite linear alternate-reverse;
        }

        @keyframes kf-glitch-anim {
            0% {
                clip: rect(16px, 9999px, 98px, 0);
            }

            5% {
                clip: rect(72px, 9999px, 83px, 0);
            }

            10% {
                clip: rect(35px, 9999px, 12px, 0);
            }

            15% {
                clip: rect(6px, 9999px, 57px, 0);
            }

            20% {
                clip: rect(93px, 9999px, 8px, 0);
            }

            25% {
                clip: rect(46px, 9999px, 2px, 0);
            }

            30% {
                clip: rect(10px, 9999px, 3px, 0);
            }

            35% {
                clip: rect(4px, 9999px, 81px, 0);
            }

            40% {
                clip: rect(68px, 9999px, 54px, 0);
            }

            45% {
                clip: rect(81px, 9999px, 13px, 0);
            }

            50% {
                clip: rect(21px, 9999px, 54px, 0);
            }

            55% {
                clip: rect(66px, 9999px, 73px, 0);
            }

            60% {
                clip: rect(47px, 9999px, 46px, 0);
            }

            65% {
                clip: rect(60px, 9999px, 75px, 0);
            }

            70% {
                clip: rect(89px, 9999px, 55px, 0);
            }

            75% {
                clip: rect(11px, 9999px, 76px, 0);
            }

            80% {
                clip: rect(41px, 9999px, 55px, 0);
            }

            85% {
                clip: rect(25px, 9999px, 35px, 0);
            }

            90% {
                clip: rect(54px, 9999px, 94px, 0);
            }

            95% {
                clip: rect(32px, 9999px, 41px, 0);
            }

            100% {
                clip: rect(18px, 9999px, 66px, 0);
            }
        }

        @keyframes kf-glitch-anim2 {
            0% {
                clip: rect(65px, 9999px, 100px, 0);
            }

            5% {
                clip: rect(52px, 9999px, 74px, 0);
            }

            10% {
                clip: rect(79px, 9999px, 85px, 0);
            }

            15% {
                clip: rect(73px, 9999px, 32px, 0);
            }

            20% {
                clip: rect(9px, 9999px, 13px, 0);
            }

            25% {
                clip: rect(83px, 9999px, 25px, 0);
            }

            30% {
                clip: rect(2px, 9999px, 46px, 0);
            }

            35% {
                clip: rect(37px, 9999px, 75px, 0);
            }

            40% {
                clip: rect(13px, 9999px, 5px, 0);
            }

            45% {
                clip: rect(57px, 9999px, 86px, 0);
            }

            50% {
                clip: rect(9px, 9999px, 25px, 0);
            }

            55% {
                clip: rect(34px, 9999px, 56px, 0);
            }

            60% {
                clip: rect(27px, 9999px, 46px, 0);
            }

            65% {
                clip: rect(93px, 9999px, 68px, 0);
            }

            70% {
                clip: rect(64px, 9999px, 12px, 0);
            }

            75% {
                clip: rect(45px, 9999px, 3px, 0);
            }

            80% {
                clip: rect(74px, 9999px, 73px, 0);
            }

            85% {
                clip: rect(17px, 9999px, 32px, 0);
            }

            90% {
                clip: rect(54px, 9999px, 28px, 0);
            }

            95% {
                clip: rect(32px, 9999px, 2px, 0);
            }

            100% {
                clip: rect(76px, 9999px, 75px, 0);
            }
        }

        @keyframes kf-pulse-blue {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 242, 255, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(0, 242, 255, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(0, 242, 255, 0);
            }
        }

        @keyframes kf-pulse-gold {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7);
                transform: scale(1);
            }

            20% {
                transform: scale(1.2);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(255, 215, 0, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
                transform: scale(1);
            }
        }

        .mic-active {
            color: #00f2ff !important;
            animation: kf-pulse-blue 2s infinite;
        }

        .mic-wake {
            color: #ffd700 !important;
            animation: kf-pulse-gold 1s ease-out;
        }

        /* DIGITAL VIRUS (MATRIX) MODE */
        .matrix-mode {
            filter: hue-rotate(120deg) contrast(1.5) brightness(1.2);
            font-family: 'Courier New', monospace !important;
            text-shadow: 2px 0 0 red, -2px 0 0 blue;
            /* RGB Split */
            animation: kf-shake 0.2s infinite, kf-glitch-skew 0.3s infinite;
        }

        .matrix-mode * {
            color: #00ff00 !important;
            border-color: #00ff00 !important;
            background-color: #000000 !important;
            font-family: 'Courier New', monospace !important;
        }

        #virusCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 99999;
            pointer-events: none;
            mix-blend-mode: screen;
            display: none;
        }

        @keyframes kf-shake {
            0% {
                transform: translate(1px, 1px) rotate(0deg);
            }

            10% {
                transform: translate(-1px, -2px) rotate(-1deg);
            }

            20% {
                transform: translate(-3px, 0px) rotate(1deg);
            }

            30% {
                transform: translate(3px, 2px) rotate(0deg);
            }

            40% {
                transform: translate(1px, -1px) rotate(1deg);
            }

            50% {
                transform: translate(-1px, 2px) rotate(-1deg);
            }

            60% {
                transform: translate(-3px, 1px) rotate(0deg);
            }

            70% {
                transform: translate(3px, 1px) rotate(-1deg);
            }

            80% {
                transform: translate(-1px, -1px) rotate(1deg);
            }

            90% {
                transform: translate(1px, 2px) rotate(0deg);
            }

            100% {
                transform: translate(1px, -2px) rotate(-1deg);
            }
        }

        @keyframes kf-glitch-skew {
            0% {
                clip-path: inset(40% 0 61% 0);
            }

            20% {
                clip-path: inset(92% 0 1% 0);
            }

            40% {
                clip-path: inset(43% 0 1% 0);
            }

            60% {
                clip-path: inset(25% 0 58% 0);
            }

            80% {
                clip-path: inset(54% 0 7% 0);
            }

            100% {
                clip-path: inset(58% 0 43% 0);
            }
        }
    </style>
</head>

<body>

    <div id="intro-shortcuts">
        <div class="intro-content">
            <div class="intro-title">Quick Guide</div>
            <div class="intro-grid">
                <div class="intro-row"><span>Start / Stop</span> <span class="key">Space</span></div>
                <div class="intro-row"><span>Reset</span> <span class="key">R</span></div>
                <div class="intro-row"><span>Mute Audio</span> <span class="key">M</span></div>
                <div class="intro-row"><span>Fullscreen</span> <span class="key">F</span></div>
                <div class="intro-row"><span>Settings</span> <span class="key">S</span></div>
                <div class="intro-row"><span>Dev HUD</span> <span class="key">~</span></div>
            </div>
        </div>
    </div>

    <div id="devHud"
        style="background: rgba(0,0,0,0.8); border: 1px solid var(--color-border-strong); border-radius: var(--dim-radius-md); padding: 15px; backdrop-filter: blur(20px); box-shadow: var(--effect-shadow-hard);">
        <div
            style="font-family: var(--font-stack-display); font-size: 12px; color: var(--color-brand-accent); margin-bottom: 10px; letter-spacing: 1px; text-transform: uppercase; font-weight: 700;">
            Cyber-HUD v2.0</div>
        <div class="hud-row"><span>Frame Rate</span><span id="hudFps"
                style="color: var(--color-state-success);">0</span></div>
        <div class="hud-row"><span>Memory Load</span><span id="hudMem"
                style="color: var(--color-brand-primary);">0</span> MB</div>
        <div class="hud-row"><span>Network Ping</span><span id="hudPing"
                style="color: var(--color-state-info);">0</span> ms</div>
        <div class="hud-row"><span>DOM Nodes</span><span id="hudDom">0</span></div>
        <div class="hud-graph" id="hudGraph"
            style="border-radius: 4px; overflow: hidden; background: rgba(255,255,255,0.05);"></div>
    </div>

    <div class="region-hud">
        <div class="widget-battery" id="widgetBattery">
            <span id="txtBattery">--%</span>
            <div class="battery-bar-container">
                <div class="battery-level" id="barBattery"></div>
            </div>
            <span id="iconCharging" style="display:none;">âš¡</span>
        </div>
    </div>

    <canvas id="particleCanvas"></canvas>
    <canvas id="virusCanvas"></canvas>
    <header class="region-header" style="top: 80px;">
        <div class="widget-date">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <span id="txtDate">SYSTEM BOOT...</span>
        </div>
        <div class="badge-status variant-streak" id="badgeStreak" title="Consecutive days used">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M17.56 11.6C17.15 8.94 15.65 6.64 13.5 5.2c-1.3-.87-2.8-1.4-4.5-1.4-3.8 0-7 2.6-7.8 6.2-.2.8-.2 1.7 0 2.5.8 3.6 4 6.3 7.8 6.3 1.7 0 3.2-.5 4.5-1.4 2.1-1.4 3.6-3.7 4-6.4.1-.5.1-1.1 0-1.6z" />
            </svg>
            <span id="valStreak">0</span> Day Streak
        </div>
        <div class="badge-status variant-focus" id="badgePomo" style="display:none;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            FOCUS MODE
        </div>
    </header>
    <nav class="region-nav hovered-element"
        style="position: absolute; top: 24px; left: 50%; transform: translateX(-50%); z-index: 100;">
        <div class="nav-links">
            <button class="btn-nav active" data-view="clock" onclick="Engine.setMode('clock')">Clock</button>
            <button class="btn-nav" data-view="stopwatch" onclick="Engine.setMode('stopwatch')">Stop</button>
            <button class="btn-nav" data-view="timer" onclick="Engine.setMode('timer')">Timer</button>
            <button class="btn-nav" data-view="pomodoro" onclick="Engine.setMode('pomodoro')">Focus</button>
            <button class="btn-nav" data-view="ledger" onclick="Engine.setMode('ledger')">History</button>
            <button class="btn-nav" data-view="world" onclick="Engine.setMode('world')">World</button>
        </div>

        <div class="nav-utils" id="navUtils">
            <div class="divider-vertical"></div>

            <button class="btn-icon" id="btnMore" onclick="UI.toggleUtils()" title="More Tools">
                <svg viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="12" cy="5" r="1"></circle>
                    <circle cx="12" cy="19" r="1"></circle>
                </svg>
            </button>

            <button class="btn-icon" id="installBtn" onclick="UI.installPWA()" title="Install App">
                <svg viewBox="0 0 24 24">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
            </button>

            <button class="btn-icon hovered-element" id="pipBtn" onclick="PiPService.toggle()"
                title="Picture-in-Picture">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="hovered-element">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    <rect x="13" y="10" width="6" height="4" rx="1"></rect>
                </svg>
            </button>

            <button class="btn-icon hovered-element" onclick="UI.toggleModal('settings')" title="Settings">
                <svg viewBox="0 0 24 24" class="hovered-element">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                        d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z">
                    </path>
                </svg>
            </button>

            <button class="btn-icon hovered-element" id="btnMic" onclick="VoiceControl.toggle()" title="Voice Command">
                <svg viewBox="0 0 24 24" class="hovered-element">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
            </button>

            <button class="btn-icon hovered-element" id="btnMute" onclick="Sound.toggle()" title="Toggle Sound">
                <svg id="iconSoundOn" viewBox="0 0 24 24">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                </svg>
            </button>

            <button class="btn-icon hovered-element" onclick="UI.toggleRotation()" title="Rotate Layout">
                <svg viewBox="0 0 24 24">
                    <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                    <path d="M21 3v5h-5"></path>
                </svg>
            </button>

            <button class="btn-icon hovered-element" onclick="Device.toggleFullscreen()" title="Fullscreen">
                <svg viewBox="0 0 24 24" class="hovered-element">
                    <path
                        d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3">
                    </path>
                </svg>
            </button>

            <button class="btn-icon" onclick="UI.toggleModal('help')" title="Help">
                <svg viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </button>
        </div>
    </nav>
    <div class="wrapper-modal" id="modal-settings">
        <div class="comp-modal">
            <div class="modal-header">
                <h2 class="modal-title">System Preferences</h2>
                <button class="btn-icon" onclick="UI.toggleModal('settings')" style="border:none;">
                    <svg viewBox="0 0 24 24">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="modal-body-section">
                <span class="label-section">Display Layout</span>
                <div class="layout-grid-2">
                    <div class="btn-option state-selected" id="optLayoutStd" onclick="UI.setLayout('standard')">Standard
                    </div>
                    <div class="btn-option" id="optLayoutUni" onclick="UI.setLayout('uniform')">Uniform</div>
                </div>
            </div>

            <div class="modal-body-section">
                <span class="label-section">Color Theme</span>
                <div class="layout-grid-2" style="margin-bottom:8px;">
                    <div class="btn-option state-selected" id="optThemeObsidian" onclick="UI.setTheme('obsidian')">
                        Obsidian</div>
                    <div class="btn-option" id="optThemePolar" onclick="UI.setTheme('polar')">Polar</div>
                </div>
                <div class="layout-grid-2">
                    <div class="btn-option" id="optThemeCyber" onclick="UI.setTheme('cyberpunk')">Cyberpunk</div>
                    <div class="btn-option" id="optThemeForest" onclick="UI.setTheme('forest')">Forest</div>
                </div>
            </div>

            <div class="modal-body-section">
                <span class="label-section">Audio Environment</span>
                <div class="layout-grid-1" style="margin-bottom:12px;">
                    <div class="btn-option" onclick="Sound.nextProfile()" style="justify-content: space-between;">
                        <span>Mechanical Profile</span>
                        <span style="opacity:0.5; font-size:11px;">Cycle Profile ðŸŽµ</span>
                    </div>
                </div>
                <div class="layout-grid-1">
                    <div class="btn-option state-selected" id="optNoiseOff" onclick="Sound.toggleNoise('off')"
                        style="margin-bottom: 8px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" style="margin-right:8px;">
                            <line x1="1" y1="1" x2="23" y2="23"></line>
                            <path d="M9 9v6a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path>
                            <path d="M17 16.95A7 7 0 0 1 5 12m14 0a7 7 0 0 1-13.12 5.12"></path>
                        </svg>
                        Off
                    </div>
                    <div class="layout-grid-2">
                        <div class="btn-option" id="optNoiseBrown" onclick="Sound.toggleNoise('brown')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" style="margin-right:8px;">
                                <path d="M12 1v22M17 5v14M7 5v14M22 9v6M2 9v6" />
                            </svg>
                            Brown
                        </div>
                        <div class="btn-option" id="optNoisePink" onclick="Sound.toggleNoise('pink')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" style="margin-right:8px;">
                                <path d="M12 1v22M17 5v14M7 5v14M22 9v6M2 9v6" />
                            </svg>
                            Pink
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-body-section">
                <span class="label-section">Hardware Safety</span>
                <div class="layout-grid-1">
                    <div class="btn-option" id="optOLED" onclick="OLEDProtection.toggle()"
                        style="justify-content: space-between;">
                        <span>OLED Screensaver</span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </div>
                </div>
                <div
                    style="font-size: 10px; color: var(--color-text-secondary); margin-top: 8px; padding: 0 4px; line-height: 1.4;">
                    Prevents burn-in by dimming and shifting pixels after 60s of inactivity.
                </div>
            </div>

            <div class="modal-body-section">
                <span class="label-section">Support</span>
                <div class="layout-grid-1">
                    <div class="btn-option" onclick="DigitalVirus.trigger()"
                        style="justify-content: space-between; color: #ff3333;">
                        <span>Report Error</span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                                d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                            </path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="wrapper-modal" id="modal-help">
        <div class="comp-modal">
            <div class="modal-header">
                <h2 class="modal-title">Shortcuts</h2>
                <button class="btn-icon" onclick="UI.toggleModal('help')" style="border:none;">
                    <svg viewBox="0 0 24 24">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <table class="table-shortcuts">
                <tr>
                    <td>Start / Pause</td>
                    <td><span class="kbd-badge">Space</span></td>
                </tr>
                <tr>
                    <td>Reset</td>
                    <td><span class="kbd-badge">R</span></td>
                </tr>
                <tr>
                    <td>Mute</td>
                    <td><span class="kbd-badge">M</span></td>
                </tr>
                <tr>
                    <td>Fullscreen</td>
                    <td><span class="kbd-badge">F</span></td>
                </tr>
                <tr>
                    <td>Settings</td>
                    <td><span class="kbd-badge">S</span></td>
                </tr>
                <tr>
                    <td>Dev HUD</td>
                    <td><span class="kbd-badge">~</span></td>
                </tr>
            </table>

            <h2 class="modal-title" style="margin-top: 20px;">Voice Commands ("Kal")</h2>
            <table class="table-shortcuts">
                <tr>
                    <td>Timers</td>
                    <td><span class="kbd-badge">"Start 20 min timer"</span></td>
                </tr>
                <tr>
                    <td>Modes</td>
                    <td><span class="kbd-badge">"Open Stopwatch"</span> <span class="kbd-badge">"World Clock"</span>
                    </td>
                </tr>
                <tr>
                    <td>Themes</td>
                    <td><span class="kbd-badge">"Dark Mode"</span> <span class="kbd-badge">"Cyberpunk Theme"</span></td>
                </tr>
                <tr>
                    <td>Controls</td>
                    <td><span class="kbd-badge">"Start"</span> <span class="kbd-badge">"Stop"</span> <span
                            class="kbd-badge">"Reset"</span></td>
                </tr>
                <tr>
                    <td>System</td>
                    <td><span class="kbd-badge">"Mute"</span> <span class="kbd-badge">"Fullscreen"</span> <span
                            class="kbd-badge">"Report Bug"</span></td>
                </tr>
            </table>
            <div style="text-align:center; margin-top:20px; font-size:11px; color:var(--color-text-secondary);">
                Titanium Clock v8.0 â€¢ Infinity Edition
            </div>
        </div>
    </div>

    <main class="region-stage" id="stage">
        <div id="view-main" style="display:contents;">
            <div class="comp-card size-large" id="cardHours">
                <div class="label-meridiem" id="lblMeridiem">PM</div>
                <div class="layer-face pos-top"><span class="text-digit">00</span></div>
                <div class="layer-face pos-bottom"><span class="text-digit">00</span></div>
                <div class="layer-face layer-flap pos-top"><span class="text-digit">00</span></div>
                <div class="layer-face layer-flap pos-bottom"><span class="text-digit">00</span></div>
            </div>
            <div class="comp-card size-large" id="cardMinutes">
                <div class="layer-face pos-top"><span class="text-digit">00</span></div>
                <div class="layer-face pos-bottom"><span class="text-digit">00</span></div>
                <div class="layer-face layer-flap pos-top"><span class="text-digit">00</span></div>
                <div class="layer-face layer-flap pos-bottom"><span class="text-digit">00</span></div>
            </div>
            <div class="comp-card size-mini" id="cardSeconds">
                <div class="layer-face pos-top"><span class="text-digit">00</span></div>
                <div class="layer-face pos-bottom"><span class="text-digit">00</span></div>
                <div class="layer-face layer-flap pos-top"><span class="text-digit">00</span></div>
                <div class="layer-face layer-flap pos-bottom"><span class="text-digit">00</span></div>
            </div>
        </div>

        <div id="view-ledger" class="page-view">
            <div class="ledger-container">
                <div class="ledger-header">
                    <h2 class="modal-title">Session Ledger</h2>
                    <button class="btn-pill" onclick="SessionLedger.exportCSV()">Export CSV</button>
                </div>
                <div class="ledger-grid">
                    <div class="ledger-chart" id="ledgerChart"></div>
                    <ul class="ledger-list" id="ledgerList"></ul>
                </div>
            </div>
        </div>

        <div id="view-world" class="page-view">
            <div class="ledger-container">
                <div class="ledger-header">
                    <h2 class="modal-title">World Clock Interpolator</h2>
                    <select class="timezone-selector" id="tzSelector" onchange="WorldClock.updateBaseTZ()">
                        <option value="local">Local Time</option>
                        <option value="UTC">UTC (Universal)</option>
                        <option value="America/New_York">New York (EST/EDT)</option>
                        <option value="Europe/London">London (GMT/BST)</option>
                        <option value="Europe/Paris">Paris (CET/CEST)</option>
                        <option value="Asia/Tokyo">Tokyo (JST)</option>
                        <option value="Asia/Dubai">Dubai (GST)</option>
                        <option value="Australia/Sydney">Sydney (AEST/AEDT)</option>
                    </select>
                </div>
                <div class="world-clock-grid" id="worldClockGrid">
                    <!-- Dynamic cards -->
                </div>
            </div>
        </div>
    </main>

    <footer class="region-footer" id="actionBar">
        <button class="btn-pill variant-primary" id="btnMain" onclick="Engine.toggleState()">START</button>
        <button class="btn-pill" id="btnReset" onclick="Engine.resetState()">RESET</button>
        <button class="btn-pill" id="btnEdit" onclick="Engine.editState()" style="display:none;">EDIT</button>
    </footer>

    <div class="popup-toast" id="toast">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <span id="toastMsg">Ready</span>
    </div>

    <div class="alarm-overlay" id="alarmOverlay">
        <div class="alarm-content">
            <div class="alarm-title" id="alarmTitle">TIME'S UP</div>
            <button class="btn-stop-alarm" id="btnStopAlarm" onclick="Sound.stopAlarm()">STOP ALARM</button>
        </div>
    </div>

    <!-- Glitch Overlay -->
    <div class="glitch-overlay" id="glitchOverlay">
        <div class="glitch-text" data-text="SYSTEM ERROR">SYSTEM ERROR</div>
    </div>

    <script>
        /**
         * -------------------------------------------------------------------
         * MODULE: Logger
         * PURPOSE: Centralized logging with visual feedback for developers.
         * -------------------------------------------------------------------
         */
        /**
         * -------------------------------------------------------------------
         * MODULE: VoiceControl
         * PURPOSE: Web Speech API integration for voice commands.
         * -------------------------------------------------------------------
         */
        class VoiceControl {
            static recognition = null;
            static active = false;
            static isListeningToCommand = false;
            static wakeWordRegex = /^(kal|cal|khal|call)\b/i;

            static init() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    UI.toast("Voice API not supported");
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                this.recognition.continuous = true;
                this.recognition.interimResults = false;
                this.recognition.lang = 'en-US';

                this.recognition.onstart = () => {
                    this.active = true;
                    const btn = document.getElementById('btnMic');
                    if (btn) btn.classList.add('mic-active');
                };

                this.recognition.onend = () => {
                    if (this.active) {
                        try { this.recognition.start(); } catch (e) { }
                    } else {
                        const btn = document.getElementById('btnMic');
                        if (btn) {
                            btn.classList.remove('mic-active');
                            btn.classList.remove('mic-wake');
                        }
                    }
                };

                this.recognition.onresult = (event) => {
                    const last = event.results.length - 1;
                    const transcript = event.results[last][0].transcript.trim().toLowerCase();
                    Logger.log(`Voice Input: ${transcript}`);

                    if (this.wakeWordRegex.test(transcript)) {
                        const command = transcript.replace(this.wakeWordRegex, '').trim();
                        this.triggerWake();
                        if (command) {
                            this.processCommand(command);
                        }
                    } else if (this.isListeningToCommand) {
                        this.processCommand(transcript);
                    }
                };

                this.recognition.onerror = (event) => {
                    if (event.error === 'not-allowed') {
                        this.toggle();
                        UI.toast("Mic Permission Denied");
                    }
                };
            }

            static toggle() {
                if (!this.recognition) this.init();
                if (!this.recognition) return;

                if (this.active) {
                    this.active = false;
                    this.recognition.stop();
                    document.getElementById('btnMic').classList.remove('mic-active');
                    UI.toast("Voice Off");
                } else {
                    this.recognition.start();
                    // UI.toast("Listening for 'Kal'..."); // Handled in onstart
                }
            }

            static triggerWake() {
                const btn = document.getElementById('btnMic');
                if (btn) {
                    btn.classList.add('mic-wake');
                    setTimeout(() => btn.classList.remove('mic-wake'), 1000);
                }
                Sound.playTone();
                this.isListeningToCommand = true;
                setTimeout(() => this.isListeningToCommand = false, 5000);
            }

            static speak(text) {
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                const v = window.speechSynthesis.getVoices().find(v => v.name.includes("Microsoft David") || v.name.includes("Google UK English Male") || v.name.includes("Male"));
                if (v) u.voice = v;
                u.pitch = 0.7; u.rate = 0.9;
                window.speechSynthesis.speak(u);
            }

            static feedback(text) {
                UI.toast(text);
                this.speak(text);
            }

            static processCommand(cmd) {
                let handled = false;

                // 1. TIMERS ("Start 20 min timer")
                const timerMatch = cmd.match(/(start|set|begin)\s+(\d+)\s*(min|minute|sec|second|hour)/i);
                if (timerMatch) {
                    const val = parseInt(timerMatch[2]);
                    const unit = timerMatch[3];
                    let ms = val * 1000;
                    if (unit.startsWith('min')) ms *= 60;
                    if (unit.startsWith('hour')) ms *= 3600;

                    Engine.setMode('timer');
                    Engine.store.timer.total = ms;
                    Engine.resetState();
                    Engine.toggleState();
                    this.feedback(`Timer set for ${val} ${unit}`);
                    handled = true;
                }

                // 2. MODES
                else if (cmd.includes('stopwatch')) { Engine.setMode('stopwatch'); this.feedback("Stopwatch"); handled = true; }
                else if (cmd.includes('clock') || cmd.includes('time')) { Engine.setMode('clock'); this.feedback("Clock Mode"); handled = true; }
                else if (cmd.includes('focus') || cmd.includes('pomodoro') || cmd.includes('work')) { Engine.setMode('pomodoro'); this.feedback("Focus Mode"); handled = true; }
                else if (cmd.includes('world') || cmd.includes('zone')) { Engine.setMode('world'); this.feedback("World Clock"); handled = true; }
                else if (cmd.includes('ledger') || cmd.includes('history')) { Engine.setMode('ledger'); this.feedback("Session History"); handled = true; }

                // 3. CONTROLS
                else if (cmd.includes('start') || cmd.includes('go') || cmd.includes('resume')) {
                    if (!Engine.store[Engine.mode].active) { Engine.toggleState(); this.feedback("Starting"); }
                    handled = true;
                }
                else if (cmd.includes('stop') || cmd.includes('pause')) {
                    if (Engine.store[Engine.mode].active) { Engine.toggleState(); this.feedback("Paused"); }
                    // Stop Alarm
                    if (document.getElementById('alarmOverlay').classList.contains('state-visible')) {
                        Sound.stopAlarm();
                        this.feedback("Alarm Stopped");
                    }
                    handled = true;
                }
                else if (cmd.includes('reset') || cmd.includes('clear')) { Engine.resetState(); this.feedback("Reset"); handled = true; }

                // 4. THEMES & LAYOUT
                else if (cmd.includes('dark') || cmd.includes('obsidian')) { UI.setTheme('obsidian'); this.feedback("Dark Mode"); handled = true; }
                else if (cmd.includes('light') || cmd.includes('polar')) { UI.setTheme('polar'); this.feedback("Light Mode"); handled = true; }
                else if (cmd.includes('cyber') || cmd.includes('neon')) { UI.setTheme('cyberpunk'); this.feedback("Cyberpunk Theme"); handled = true; }
                else if (cmd.includes('forest') || cmd.includes('green')) { UI.setTheme('forest'); this.feedback("Forest Theme"); handled = true; }
                else if (cmd.includes('uniform')) { UI.setLayout('uniform'); this.feedback("Uniform Layout"); handled = true; }
                else if (cmd.includes('rotate') || cmd.includes('landscape')) { UI.toggleRotation(); this.feedback("Rotating"); handled = true; }

                // 5. SOUND
                else if (cmd.includes('mute') || cmd.includes('silent')) { Sound.toggle(); this.feedback("Audio Toggled"); handled = true; }
                else if (cmd.includes('brown')) { Sound.toggleNoise('brown'); this.feedback("Brown Noise"); handled = true; }
                else if (cmd.includes('pink')) { Sound.toggleNoise('pink'); this.feedback("Pink Noise"); handled = true; }
                else if (cmd.includes('white')) { Sound.toggleNoise('white'); this.feedback("White Noise"); handled = true; }
                else if (cmd.includes('stop noise')) { Sound.toggleNoise('off'); this.feedback("Noise Off"); handled = true; }

                // 6. SYSTEM
                else if (cmd.includes('full') || cmd.includes('screen')) { Device.toggleFullscreen(); this.feedback("Fullscreen"); handled = true; }
                else if (cmd.includes('settings')) { UI.toggleModal('settings'); this.feedback("Settings"); handled = true; }
                else if (cmd.includes('close')) { UI.toggleModal(null); this.feedback("Closed"); handled = true; }
                else if (cmd.includes('reload') || cmd.includes('refresh')) { location.reload(); handled = true; }
                else if (cmd.includes('bug') || cmd.includes('virus') || cmd.includes('report')) { DigitalVirus.trigger(); this.feedback("Virus Protocol Initiated"); handled = true; }
                else if (cmd.includes('install')) { UI.installPWA(); this.feedback("Installing"); handled = true; }

                if (handled) {
                    Sound.playTone();
                    const btn = document.getElementById('btnMic');
                    if (btn) {
                        btn.style.transform = 'scale(1.2)';
                        setTimeout(() => btn.style.transform = 'none', 200);
                    }
                }
            }
        }

        class Logger {
            static log(msg, data = '') {
                console.log(`%c[Ti-Clock] ${msg}`, 'color: #00cec9; font-weight: bold;', data);
            }
            static warn(msg) {
                console.warn(`%c[Ti-Clock] Warning: ${msg}`, 'color: #ff9f43; font-weight: bold;');
            }
            static error(msg) {
                console.error(`%c[Ti-Clock] Error: ${msg}`, 'color: #ff4757; font-weight: bold;');
            }
        }

        /**
         * -------------------------------------------------------------------
         * MODULE: DevTools
         * PURPOSE: Internal performance monitoring (HUD).
         * -------------------------------------------------------------------
         */
        class DevTools {
            static active = false;
            static lastFrame = 0;
            static frameCount = 0;
            static fps = 0;

            static toggle() {
                this.active = !this.active;
                document.getElementById('devHud').style.display = this.active ? 'block' : 'none';
                if (this.active) this.loop();
            }

            static loop() {
                if (!this.active) return;
                const now = performance.now();
                this.frameCount++;
                if (now - this.lastFrame >= 1000) {
                    this.fps = this.frameCount;
                    this.frameCount = 0;
                    this.lastFrame = now;
                    this.update();
                }
                requestAnimationFrame(() => this.loop());
            }

            static update() {
                document.getElementById('hudFps').innerText = this.fps;
                if (performance.memory) {
                    document.getElementById('hudMem').innerText = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                }
                document.getElementById('hudDom').innerText = document.getElementsByTagName('*').length;

                // Ping Logic
                const start = performance.now();
                fetch('https://www.google.com/favicon.ico', { mode: 'no-cors', cache: 'no-cache' })
                    .then(() => {
                        const ping = Math.round(performance.now() - start);
                        document.getElementById('hudPing').innerText = ping;
                    })
                    .catch(() => {
                        document.getElementById('hudPing').innerText = 'ERR';
                    });

                // Graph visualization logic
                const graph = document.getElementById('hudGraph');
                const bar = document.createElement('div');
                bar.className = 'hud-bar';
                bar.style.height = Math.min(this.fps / 60 * 100, 100) + '%';
                bar.style.left = '100%';
                graph.appendChild(bar);

                // Shift bars
                Array.from(graph.children).forEach(b => {
                    let left = parseFloat(b.style.left) || 100;
                    left -= 2;
                    b.style.left = left + '%';
                    if (left < 0) b.remove();
                });
            }
        }

        /**
         * -------------------------------------------------------------------
         * MODULE: Storage
         * PURPOSE: Persistent data layer using Cookies.
         * -------------------------------------------------------------------
         */
        class Storage {
            /**
             * Set a secure cookie with expiration.
             * @param {string} key
             * @param {string} val
             * @param {number} days
             */
            static set(key, val, days = 365) {
                const d = new Date();
                d.setTime(d.getTime() + (days * 86400000));
                document.cookie = `${key}=${val};expires=${d.toUTCString()};path=/;SameSite=Strict`;
            }

            /**
             * Retrieve cookie by key.
             * @param {string} key
             * @returns {string|null}
             */
            static get(key) {
                const n = key + "=";
                const ca = document.cookie.split(';');
                for (let i = 0; i < ca.length; i++) {
                    let c = ca[i].trim();
                    if (c.indexOf(n) === 0) return c.substring(n.length, c.length);
                }
                return null;
            }
        }

        /**
         * -------------------------------------------------------------------
         * MODULE: Device
         * PURPOSE: Interface for hardware APIs (WakeLock, Fullscreen).
         * -------------------------------------------------------------------
         */
        class Device {
            static wakeLock = null;

            static async requestWakeLock() {
                if ('wakeLock' in navigator) {
                    try {
                        this.wakeLock = await navigator.wakeLock.request('screen');
                        Logger.log("Wake Lock Acquired");
                    } catch (e) {
                        Logger.warn("Wake Lock denied");
                    }
                }
            }

            static toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(e => Logger.error(e));
                } else {
                    if (document.exitFullscreen) document.exitFullscreen();
                }
            }
        }

        /**
         * -------------------------------------------------------------------
         * MODULE: PiPService
         * PURPOSE: Quantum Picture-in-Picture Rendering Engine.
         * -------------------------------------------------------------------
         */
        class PiPService {
            static video = null;
            static canvas = null;
            static ctx = null;
            static active = false;
            static isToggling = false;

            static init() {
                if (!this.canvas) {
                    this.canvas = document.createElement('canvas');
                    this.canvas.width = 500;
                    this.canvas.height = 300;
                    this.ctx = this.canvas.getContext('2d');

                    // Initialize canvas content to prevent black flash
                    this.ctx.fillStyle = '#111';
                    this.ctx.fillRect(0, 0, 500, 300);
                    this.ctx.fillStyle = '#ff9800';
                    this.ctx.font = 'bold 30px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('Ti-Clock', 250, 150);

                    this.video = document.createElement('video');
                    this.video.muted = true;
                    this.video.autoplay = true;
                    this.video.playsInline = true;
                }
            }

            static fallbackWindow = null;
            static fallbackCtx = null;

            static isSupported() {
                return document.pictureInPictureEnabled &&
                    'requestPictureInPicture' in HTMLVideoElement.prototype;
            }

            static async toggle() {
                if (this.isToggling) return;

                // Check for fallback closing
                if (this.fallbackWindow && !this.fallbackWindow.closed) {
                    this.fallbackWindow.close();
                    this.fallbackWindow = null;
                    this.fallbackCtx = null;
                    this.active = false;
                    UI.toast("PiP Closed");
                    return;
                }

                // Native support check (secure context required for native PiP)
                const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
                if (!this.isSupported() || !isSecure) {
                    this.toggleFallback();
                    return;
                }

                this.isToggling = true;
                this.init();

                try {
                    if (document.pictureInPictureElement) {
                        await document.exitPictureInPicture();
                        this.active = false;
                        UI.toast("PiP Closed");
                    } else {
                        if (!this.video.srcObject) {
                            const stream = this.canvas.captureStream(30);
                            this.video.srcObject = stream;
                        }

                        try {
                            await this.video.play();
                        } catch (e) {
                            console.warn("PiP Play interrupted: " + e.message);
                        }

                        await this.video.requestPictureInPicture();
                        this.active = true;
                        UI.toast("PiP Activated");
                    }
                } catch (err) {
                    console.error("PiP Native Failed, trying fallback: " + err);
                    this.isToggling = false; // Reset lock before fallback
                    this.toggleFallback();
                } finally {
                    this.isToggling = false;
                }
            }

            static toggleFallback() {
                if (this.fallbackWindow && !this.fallbackWindow.closed) {
                    this.fallbackWindow.close();
                    return;
                }

                this.init(); // Ensure canvas is ready
                this.active = true; // Enable updating

                const w = 500;
                const h = 300;
                // Calculate center
                const left = (window.screen.width - w) / 2;
                const top = (window.screen.height - h) / 2;

                this.fallbackWindow = window.open('', 'TiClockPiP', `width=${w},height=${h},top=${top},left=${left},resizable=yes,alwaysOnTop=yes`);

                if (!this.fallbackWindow) {
                    UI.toast("Popup blocked! Allow popups for PiP.");
                    this.active = false;
                    return;
                }

                const d = this.fallbackWindow.document;
                d.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Ti-Clock PiP</title>
                        <style>
                            body { margin: 0; background: #111; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
                            canvas { width: 100%; height: 100%; object-fit: contain; }
                        </style>
                    </head>
                    <body>
                        <canvas id="pipCanvas" width="500" height="300"></canvas>
                    </body>
                    </html>
                `);
                d.close();

                // Get context after small delay to ensure DOM is ready
                setTimeout(() => {
                    const c = d.getElementById('pipCanvas');
                    if (c) {
                        this.fallbackCtx = c.getContext('2d');
                        // Sync close state
                        this.fallbackWindow.onbeforeunload = () => {
                            this.active = false;
                            this.fallbackWindow = null;
                            this.fallbackCtx = null;
                            UI.toast("PiP Closed");
                        };
                        UI.toast("Popup PiP Activated");
                    }
                }, 100);
            }

            static update(val, label = 'Ti-Clock') {
                if (!this.active) return;

                // Determine targets
                const targets = [];
                if (this.ctx) targets.push(this.ctx);
                if (this.fallbackCtx && this.fallbackWindow && !this.fallbackWindow.closed) targets.push(this.fallbackCtx);

                if (targets.length === 0) return;

                const w = 500;
                const h = 300;
                const cardW = 380;
                const cardH = 160;
                const cardX = (w - cardW) / 2;
                const cardY = (h - cardH) / 2 + 20;
                const radius = 24;

                targets.forEach(ctx => {
                    // Clear
                    ctx.fillStyle = '#111';
                    ctx.fillRect(0, 0, w, h);

                    // Draw Card Background (Dark Grey)
                    ctx.fillStyle = '#1e1e1e';
                    ctx.beginPath();
                    ctx.moveTo(cardX + radius, cardY);
                    ctx.lineTo(cardX + cardW - radius, cardY);
                    ctx.quadraticCurveTo(cardX + cardW, cardY, cardX + cardW, cardY + radius);
                    ctx.lineTo(cardX + cardW, cardY + cardH - radius);
                    ctx.quadraticCurveTo(cardX + cardW, cardY + cardH, cardX + cardW - radius, cardY + cardH);
                    ctx.lineTo(cardX + radius, cardY + cardH);
                    ctx.quadraticCurveTo(cardX, cardY + cardH, cardX, cardY + cardH - radius);
                    ctx.lineTo(cardX, cardY + radius);
                    ctx.quadraticCurveTo(cardX, cardY, cardX + radius, cardY);
                    ctx.closePath();
                    ctx.fill();

                    // Draw Split Line
                    ctx.fillStyle = '#000';
                    ctx.fillRect(cardX, cardY + (cardH / 2) - 2, cardW, 4);

                    // Label
                    ctx.fillStyle = '#ff9800';
                    ctx.font = 'bold 24px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(label, 250, 60);

                    // Time Value
                    ctx.fillStyle = '#e0e0e0';
                    ctx.font = 'bold 100px Courier New';
                    ctx.textBaseline = 'middle';
                    ctx.shadowColor = "rgba(0,0,0,0.5)";
                    ctx.shadowBlur = 10;
                    ctx.shadowOffsetY = 5;
                    ctx.fillText(val, 250, cardY + (cardH / 2) + 5);

                    // Reset Shadow
                    ctx.shadowColor = "transparent";
                    ctx.shadowBlur = 0;
                    ctx.shadowOffsetY = 0;
                });
            }
        }

        class CursorEffect {
            static dot = null;
            static outline = null;
            static cursorX = 0;
            static cursorY = 0;
            static outlineX = 0;
            static outlineY = 0;

            static init() {
                // Cleanup existing
                const oldDot = document.querySelector('.cursor-dot');
                const oldOutline = document.querySelector('.cursor-outline');
                if (oldDot) oldDot.remove();
                if (oldOutline) oldOutline.remove();

                // Create Elements
                this.dot = document.createElement('div');
                this.dot.className = 'cursor-dot';

                this.outline = document.createElement('div');
                this.outline.className = 'cursor-outline';

                document.body.appendChild(this.dot);
                document.body.appendChild(this.outline);

                // Initialize pos
                this.cursorX = window.innerWidth / 2;
                this.cursorY = window.innerHeight / 2;
                this.outlineX = this.cursorX;
                this.outlineY = this.cursorY;

                // Listeners
                document.addEventListener('mousemove', (e) => {
                    this.cursorX = e.clientX;
                    this.cursorY = e.clientY;

                    // Dot follows instantly
                    this.dot.style.left = `${this.cursorX}px`;
                    this.dot.style.top = `${this.cursorY}px`;

                    // Ensure visible on move
                    this.dot.style.opacity = '1';
                    this.outline.style.opacity = '1';
                });

                document.addEventListener('mousedown', () => document.body.classList.add('clicking'));
                document.addEventListener('mouseup', () => document.body.classList.remove('clicking'));

                document.addEventListener('mouseleave', () => {
                    this.dot.style.opacity = '0';
                    this.outline.style.opacity = '0';
                });
                document.addEventListener('mouseenter', () => {
                    this.dot.style.opacity = '1';
                    this.outline.style.opacity = '1';
                });

                // Start Loop
                this.animate();
                this.refreshTargets();

                // Refresh targets on mutations (e.g. modal open)
                const observer = new MutationObserver(() => this.refreshTargets());
                observer.observe(document.body, { childList: true, subtree: true });
            }

            static animate() {
                // Smooth elastic follow
                const speed = 0.15;
                this.outlineX += (this.cursorX - this.outlineX) * speed;
                this.outlineY += (this.cursorY - this.outlineY) * speed;

                this.outline.style.left = `${this.outlineX}px`;
                this.outline.style.top = `${this.outlineY}px`;

                requestAnimationFrame(() => this.animate());
            }

            static refreshTargets() {
                const triggers = document.querySelectorAll('button, a, input, select, .btn-option, .comp-card, .btn-icon, .btn-pill, .btn-nav, .ledger-item, .world-clock-card');

                triggers.forEach(el => {
                    // Avoid duplicate listeners
                    if (el.dataset.cursorBound) return;
                    el.dataset.cursorBound = "true";

                    el.addEventListener('mouseenter', () => {
                        document.body.classList.add('hovering');

                        // RESTRICTED SOUND: Only play for Nav Bar or Settings Modal elements
                        const isNavBar = el.classList.contains('btn-nav');
                        const isSettings = el.closest('#modal-settings');

                        if (isNavBar || isSettings) {
                            Sound.playHover();
                        }
                    });
                    el.addEventListener('mouseleave', () => document.body.classList.remove('hovering'));
                });
            }
        }

        /**
         * -------------------------------------------------------------------
         * MODULE: ShakeDetector
         * PURPOSE: Detects device shaking to trigger bug report.
         * -------------------------------------------------------------------
         */
        class ShakeDetector {
            static threshold = 15; // Adjusted sensitivity
            static lastX = null;
            static lastY = null;
            static lastZ = null;
            static lastUpdate = 0;
            static shakeCount = 0;
            static lastShakeTime = 0;

            static init() {
                if ('ondevicemotion' in window) {
                    window.addEventListener('devicemotion', (e) => this.handleMotion(e), false);
                }
            }

            static handleMotion(e) {
                const acc = e.accelerationIncludingGravity;
                if (!acc) return;

                const curTime = Date.now();
                if ((curTime - this.lastUpdate) > 100) {
                    const diffTime = curTime - this.lastUpdate;
                    this.lastUpdate = curTime;

                    const x = acc.x;
                    const y = acc.y;
                    const z = acc.z;

                    if (this.lastX !== null) {
                        const speed = Math.abs(x + y + z - this.lastX - this.lastY - this.lastZ) / diffTime * 10000;

                        if (speed > this.threshold * 100) { // Uses lower threshold
                            this.shakeCount++;
                            const now = Date.now();

                            // Check for 3 shakes within 1 second
                            if (now - this.lastShakeTime > 1000) {
                                this.shakeCount = 1;
                            }
                            this.lastShakeTime = now;

                            if (this.shakeCount >= 3) {
                                this.triggerBugReport();
                                this.shakeCount = 0;
                            }
                        }
                    }

                    this.lastX = x;
                    this.lastY = y;
                    this.lastZ = z;
                }
            }

            static triggerBugReport() {
                DigitalVirus.trigger();
            }
        }

        /**
         * -------------------------------------------------------------------
         * MODULE: Sound
         * PURPOSE: Procedural audio synthesis.
         * -------------------------------------------------------------------
         */
        class Sound {
            static ctx = null;
            static muted = false;
            static profile = 'tic';
            static profiles = ['tic', 'flip', 'clack'];
            static noiseNode = null;
            static noiseType = null;

            static init() {
                if (!this.ctx) {
                    const AC = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AC();

                    // Bind Stop Button strictly
                    const stopBtn = document.getElementById('btnStopAlarm');
                    if (stopBtn) {
                        stopBtn.onclick = (e) => {
                            e.stopPropagation();
                            this.stopAlarm();
                        };
                    }
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
            }

            static toggleNoise(type) {
                this.init();
                if (type === 'off') {
                    this.stopNoise();
                } else if (this.noiseType === type) {
                    this.stopNoise();
                } else {
                    this.stopNoise();
                    this.startNoise(type);
                }
            }

            static stopNoise() {
                if (this.noiseNode) {
                    this.noiseNode.disconnect();
                    this.noiseNode = null;
                }
                this.noiseType = null;
                document.getElementById('optNoiseOff').classList.add('state-selected');
                document.getElementById('optNoiseBrown').classList.remove('state-selected');
                document.getElementById('optNoisePink').classList.remove('state-selected');
            }

            static startNoise(type) {
                this.noiseType = type;
                const btnId = type === 'brown' ? 'optNoiseBrown' : 'optNoisePink';
                document.getElementById('optNoiseOff').classList.remove('state-selected');
                document.getElementById(btnId).classList.add('state-selected');

                const bufferSize = 4096;
                this.noiseNode = this.ctx.createScriptProcessor(bufferSize, 1, 1);

                let lastOut = 0.0; // For brown noise
                let b0, b1, b2, b3, b4, b5, b6; // For pink noise
                b0 = b1 = b2 = b3 = b4 = b5 = b6 = 0.0;

                this.noiseNode.onaudioprocess = (e) => {
                    const output = e.outputBuffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) {
                        const white = Math.random() * 2 - 1;
                        if (type === 'brown') {
                            // Brown noise: integration of white noise
                            output[i] = (lastOut + (0.02 * white)) / 1.02;
                            lastOut = output[i];
                            output[i] *= 3.5; // volume compensation
                        } else {
                            // Pink noise: Voss-McCartney algorithm
                            b0 = 0.99886 * b0 + white * 0.0555179;
                            b1 = 0.99332 * b1 + white * 0.0750759;
                            b2 = 0.96900 * b2 + white * 0.1538520;
                            b3 = 0.86650 * b3 + white * 0.3104856;
                            b4 = 0.55000 * b4 + white * 0.5329522;
                            b5 = -0.7616 * b5 - white * 0.0168980;
                            output[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
                            output[i] *= 0.11; // volume compensation
                            b6 = white * 0.115926;
                        }
                    }
                };

                const gain = this.ctx.createGain();
                gain.gain.value = 0.3;
                this.noiseNode.connect(gain);
                gain.connect(this.ctx.destination);
            }

            static toggle() {
                this.muted = !this.muted;
                document.getElementById('btnMute').style.opacity = this.muted ? "0.5" : "1";
                UI.toast(this.muted ? "Audio Muted" : "Audio Enabled");
            }

            static nextProfile() {
                let idx = this.profiles.indexOf(this.profile);
                this.profile = this.profiles[(idx + 1) % this.profiles.length];
                UI.toast(`Sound: ${this.profile.toUpperCase()}`);
                if (!this.muted) this.playTone();
            }

            static playTone() {
                if (this.muted) return;
                this.init();

                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.connect(gain);
                gain.connect(this.ctx.destination);

                if (this.profile === 'tic') {
                    // Clear, sharp mechanical click
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(1200, t);
                    osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.05); // Rapid pitch drop

                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.5, t + 0.001);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);

                    osc.start(t);
                    osc.stop(t + 0.05);
                } else if (this.profile === 'flip') {
                    // Heavy thud for card flipping
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(150, t);
                    osc.frequency.linearRampToValueAtTime(100, t + 0.1);

                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.6, t + 0.005);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);

                    osc.start(t);
                    osc.stop(t + 0.1);
                } else {
                    // Clack / Snap sound
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(400, t);
                    osc.frequency.exponentialRampToValueAtTime(100, t + 0.05);

                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.15, t + 0.001); // Lower volume for square
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);

                    osc.start(t);
                    osc.stop(t + 0.05);
                }
            }

            static alarmOsc = null;
            static alarmInterval = null;
            static isAlarming = false;

            static startAlarm() {
                if (this.muted || this.isAlarming) return;
                this.init();
                this.isAlarming = true;

                // Show Overlay
                document.getElementById('alarmOverlay').classList.add('state-visible');

                const playBeep = () => {
                    if (!this.isAlarming) return;

                    const t = this.ctx.currentTime;
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();

                    // Loud, annoying Sawtooth
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(800, t);
                    osc.frequency.linearRampToValueAtTime(1200, t + 0.1); // Siren effect

                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.8, t + 0.05); // High Volume
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.4);

                    osc.connect(gain);
                    gain.connect(this.ctx.destination);

                    osc.start(t);
                    osc.stop(t + 0.5);
                };

                playBeep();
                this.alarmInterval = setInterval(playBeep, 800); // Repeat every 800ms

                // Vibrate device
                if ('vibrate' in navigator) {
                    navigator.vibrate([200, 100, 200]);
                    this.vibrateInterval = setInterval(() => {
                        navigator.vibrate([200, 100, 200]);
                    }, 800);
                }
            }

            static stopAlarm() {
                this.isAlarming = false;
                if (this.alarmInterval) {
                    clearInterval(this.alarmInterval);
                    this.alarmInterval = null;
                }
                if (this.vibrateInterval) {
                    clearInterval(this.vibrateInterval);
                    this.vibrateInterval = null;
                    if ('vibrate' in navigator) navigator.vibrate(0);
                }
                // Hide Overlay
                document.getElementById('alarmOverlay').classList.remove('state-visible');
            }

            static playHover() {
                if (this.muted) return;
                this.init();
                const t = this.ctx.currentTime;

                // Sci-fi Robot Click: High frequency chirp + low thud
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                // High pitch chirp
                osc.type = 'sine';
                osc.frequency.setValueAtTime(2000, t);
                osc.frequency.exponentialRampToValueAtTime(500, t + 0.05);

                gain.gain.setValueAtTime(0.05, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);

                osc.connect(gain);
                gain.connect(this.ctx.destination);

                osc.start(t);
                osc.stop(t + 0.05);
            }
        }

        /**
         * -------------------------------------------------------------------
         * MODULE: ParticleSystem
         * PURPOSE: Canvas-based background visuals.
         * -------------------------------------------------------------------
         */
        class ParticleSystem {
            static canvas;
            static ctx;
            static particles = [];
            static w;
            static h;

            static init() {
                this.canvas = document.getElementById('particleCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());

                // Initialize particle pool
                for (let i = 0; i < 50; i++) {
                    this.particles.push(this.createParticle());
                }
                this.animate();
            }

            static resize() {
                this.w = this.canvas.width = window.innerWidth;
                this.h = this.canvas.height = window.innerHeight;
            }

            static createParticle() {
                return {
                    x: Math.random() * this.w,
                    y: Math.random() * this.h,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    size: Math.random() * 2 + 1
                };
            }

            static animate() {
                this.ctx.clearRect(0, 0, this.w, this.h);

                const style = getComputedStyle(document.documentElement);
                const color = style.getPropertyValue('--effect-particle-fill').trim();

                this.ctx.fillStyle = color || 'rgba(255,255,255,0.1)';

                this.particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;

                    // Boundary Wrapping
                    if (p.x < 0) p.x = this.w;
                    if (p.x > this.w) p.x = 0;
                    if (p.y < 0) p.y = this.h;
                    if (p.y > this.h) p.y = 0;

                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    this.ctx.fill();
                });

                requestAnimationFrame(() => this.animate());
            }
        }

        /**
         * -------------------------------------------------------------------
         * MODULE: OLEDProtection
         * PURPOSE: Prevent burn-in via pixel shifting and dimming.
         * -------------------------------------------------------------------
         */
        class OLEDProtection {
            static enabled = false;
            static idleTime = 0;
            static isDimmed = false;

            static init() {
                this.enabled = Storage.get('pref_oled') === 'true';
                if (this.enabled) document.getElementById('optOLED').classList.add('state-selected');

                const resetIdle = () => {
                    this.idleTime = 0;
                    if (this.isDimmed) this.wake();
                };

                window.addEventListener('mousemove', resetIdle);
                window.addEventListener('keydown', resetIdle);
                window.addEventListener('touchstart', resetIdle);

                setInterval(() => this.tick(), 1000);
            }

            static toggle() {
                this.enabled = !this.enabled;
                Storage.set('pref_oled', this.enabled);
                document.getElementById('optOLED').classList.toggle('state-selected', this.enabled);
                UI.toast(this.enabled ? "OLED Protection ON" : "OLED Protection OFF");
                if (!this.enabled) this.wake();
            }

            static tick() {
                if (!this.enabled) return;
                this.idleTime++;

                if (this.idleTime >= 60 && !this.isDimmed) {
                    this.dim();
                }

                if (this.isDimmed && this.idleTime % 60 === 0) {
                    this.shift();
                }
            }

            static dim() {
                this.isDimmed = true;
                document.body.style.filter = 'brightness(0.4)';
                document.querySelector('.region-header').style.opacity = '0';
                document.querySelector('.region-nav').style.opacity = '0';
                document.querySelector('.region-footer').style.opacity = '0';
                document.querySelector('.region-hud').style.opacity = '0';
            }

            static wake() {
                this.isDimmed = false;
                document.body.style.filter = 'none';
                document.querySelector('.region-header').style.opacity = '1';
                document.querySelector('.region-nav').style.opacity = '1';
                document.querySelector('.region-footer').style.opacity = '1';
                document.querySelector('.region-hud').style.opacity = '1';
                document.getElementById('stage').style.transform = 'none';
            }

            static shift() {
                const x = (Math.random() - 0.5) * 40;
                const y = (Math.random() - 0.5) * 40;
                document.getElementById('stage').style.transform = `translate(${x}px, ${y}px)`;
            }
        }

        /**
         * -------------------------------------------------------------------
         * MODULE: DigitalVirus
         * PURPOSE: Visual glitch bug report system (Matrix Dissolve).
         * -------------------------------------------------------------------
         */
        class DigitalVirus {
            static active = false;
            static canvas = null;
            static ctx = null;
            static drops = [];
            static interval = null;
            static scrambleInterval = null;

            static init() {
                // Shake detection logic consolidated in ShakeDetector class
            }

            static trigger() {
                if (this.active) return;
                this.active = true;

                document.body.classList.add('matrix-mode');
                UI.toast("âš ï¸ SYSTEM BREACH: MATRIX PROTOCOL âš ï¸");

                this.canvas = document.getElementById('virusCanvas');
                this.canvas.style.display = 'block';
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                this.ctx = this.canvas.getContext('2d');

                const fontSize = 16;
                const columns = this.canvas.width / fontSize;
                this.drops = Array(Math.floor(columns)).fill(1);

                this.playGlitch();

                // Start Matrix Rain
                this.interval = setInterval(() => this.animate(), 40);

                // Start Text Scrambling
                this.scrambleInterval = setInterval(() => this.scrambleDOM(), 150);

                setTimeout(() => {
                    this.stop();
                }, 5000);
            }

            static scrambleDOM() {
                const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null, false);
                let node;
                while (node = walker.nextNode()) {
                    if (node.parentElement.tagName !== 'SCRIPT' && node.parentElement.tagName !== 'STYLE' && Math.random() > 0.9) {
                        node.textContent = node.textContent.split('').map(c => Math.random() > 0.5 ? (Math.random() > 0.5 ? '0' : '1') : c).join('');
                    }
                }
            }

            static animate() {
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                this.ctx.fillStyle = '#0f0';
                this.ctx.font = '16px monospace';

                for (let i = 0; i < this.drops.length; i++) {
                    const text = Math.random() > 0.5 ? '0' : '1';
                    this.ctx.fillText(text, i * 16, this.drops[i] * 16);

                    if (this.drops[i] * 16 > this.canvas.height && Math.random() > 0.975) {
                        this.drops[i] = 0;
                    }
                    this.drops[i]++;
                }
            }

            static stop() {
                this.active = false;
                clearInterval(this.interval);
                clearInterval(this.scrambleInterval);
                document.body.classList.remove('matrix-mode');
                if (this.canvas) this.canvas.style.display = 'none';

                // DATA EXFILTRATION (Bug Report)
                try {
                    const report = this.generateReport();
                    const subject = encodeURIComponent("TITANIUM CLOCK BUG REPORT [SYSTEM FAILURE]");
                    const body = encodeURIComponent(report);
                    window.location.href = `mailto:support@titaniumclock.com?subject=${subject}&body=${body}`;
                } catch (e) {
                    console.error("Report generation failed:", e);
                }

                UI.toast("â™»ï¸ SYSTEM REBOOTING...");
                setTimeout(() => location.reload(), 3000);
            }

            static generateReport() {
                const ua = navigator.userAgent;
                const winSize = `${window.innerWidth}x${window.innerHeight}`;
                const screenRes = `${window.screen.width}x${window.screen.height}`;
                const time = new Date().toISOString();
                const platform = navigator.platform;
                const vendor = navigator.vendor || 'Unknown';
                const cores = navigator.hardwareConcurrency || '?';
                const mem = navigator.deviceMemory || '?';
                const lang = navigator.language;
                const online = navigator.onLine;
                const cookies = navigator.cookieEnabled;
                const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const dpr = window.devicePixelRatio;
                const visibility = document.visibilityState;

                // App State
                const mode = Engine.mode;
                const swActive = Engine.store.stopwatch.active;
                const timerActive = Engine.store.timer.active;
                const pomoActive = Engine.store.pomodoro.active;

                return `
[TITANIUM CLOCK - ADVANCED FAILURE REPORT]
-----------------------------------------
TIMESTAMP: ${time}
TIMEZONE:  ${tz}

DEVICE INFO:
- Platform:  ${platform}
- Vendor:    ${vendor}
- Hardware:  ${cores} Cores, ${mem}GB RAM
- Screen:    ${screenRes} (DPR: ${dpr})
- Window:    ${winSize}
- Language:  ${lang}
- User Agent: ${ua}

ENVIRONMENT:
- Online:    ${online}
- Cookies:   ${cookies}
- Visibility: ${visibility}

APP STATE:
- Current Mode: ${mode}
- Stopwatch:    ${swActive ? 'RUNNING' : 'IDLE'}
- Timer:        ${timerActive ? 'RUNNING' : 'IDLE'}
- Pomodoro:     ${pomoActive ? 'RUNNING' : 'IDLE'}

-----------------------------------------
ERROR_CODE: MATRIX_BRAVO_INF
DESCRIBE THE STEPS TO REPRODUCE BELOW:
-----------------------------------------
`;
            }

            static playGlitch() {
                const ctx = Sound.ctx || new (window.AudioContext || window.webkitAudioContext)();
                if (!ctx) return;

                const createOsc = (type, freq, detune, duration) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, ctx.currentTime);
                    osc.detune.setValueAtTime(detune, ctx.currentTime);

                    // Modulate frequency
                    osc.frequency.linearRampToValueAtTime(freq * 0.5, ctx.currentTime + duration);

                    gain.gain.setValueAtTime(0.3, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);

                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start();
                    osc.stop(ctx.currentTime + duration);
                };

                // Layered glitch sounds
                createOsc('sawtooth', 150, 0, 0.5);
                createOsc('square', 100, 50, 0.4);
                createOsc('sawtooth', 800, -50, 0.2);

                // Static noise burst
                const bufferSize = ctx.sampleRate * 0.5;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;

                const noise = ctx.createBufferSource();
                noise.buffer = buffer;
                const nGain = ctx.createGain();
                nGain.gain.setValueAtTime(0.2, ctx.currentTime);
                nGain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
                noise.connect(nGain);
                nGain.connect(ctx.destination);
                noise.start();
            }
        }


        /**
         * -------------------------------------------------------------------
         * MODULE: WorldClock
         * PURPOSE: Timezone interpolation and world time.
         * -------------------------------------------------------------------
         */
        class WorldClock {
            static zones = [
                { name: 'New York', id: 'America/New_York' },
                { name: 'London', id: 'Europe/London' },
                { name: 'Tokyo', id: 'Asia/Tokyo' },
                { name: 'Dubai', id: 'Asia/Dubai' }
            ];

            static updateBaseTZ() {
                const tz = document.getElementById('tzSelector').value;
                Engine.store.world.timezone = tz;
                UI.toast(`Clock shifted to ${tz}`);
            }

            static render() {
                const grid = document.getElementById('worldClockGrid');
                grid.innerHTML = '';

                this.zones.forEach(zone => {
                    const card = document.createElement('div');
                    card.className = 'world-clock-card';
                    // Add click interaction
                    card.onclick = () => this.selectZone(zone.id, zone.name);
                    card.style.cursor = 'none'; // Ensure custom cursor is used
                    card.innerHTML = `
                            <div class="world-clock-label">${zone.name}</div>
                            <div class="world-clock-time" id="tz-${zone.id.replace(/\//g, '-')}">--:--:--</div>
                        `;
                    grid.appendChild(card);
                });
                this.update();
            }

            static selectZone(id, name) {
                Engine.store.world.timezone = id;
                document.getElementById('tzSelector').value = id; // Sync selector if exists
                UI.toast(`Main Clock Set to ${name}`);
            }

            static update() {
                if (Engine.mode !== 'world') return;
                const now = new Date();
                this.zones.forEach(zone => {
                    const timeStr = new Intl.DateTimeFormat('en-US', {
                        timeZone: zone.id,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    }).format(now);
                    const el = document.getElementById(`tz-${zone.id.replace(/\//g, '-')}`);
                    if (el) el.innerText = timeStr;
                });
                requestAnimationFrame(() => this.update());
            }
        }

        /**
         * -------------------------------------------------------------------
         * MODULE: SessionLedger
         * PURPOSE: Productivity analytics and history.
         * -------------------------------------------------------------------
         */
        class SessionLedger {
            static history = [];

            static init() {
                const saved = Storage.get('app_history');
                if (saved) this.history = JSON.parse(saved);
            }

            static log(type, duration) {
                const entry = {
                    timestamp: Date.now(),
                    type: type, // 'focus' or 'break'
                    duration: duration, // in ms
                    date: new Date().toLocaleDateString()
                };
                this.history.push(entry);
                Storage.set('app_history', JSON.stringify(this.history.slice(-100))); // Keep last 100
            }

            static render() {
                const list = document.getElementById('ledgerList');
                const chart = document.getElementById('ledgerChart');
                list.innerHTML = '';
                chart.innerHTML = '';

                // Render List (Last 10)
                this.history.slice(-10).reverse().forEach(entry => {
                    const li = document.createElement('li');
                    li.className = 'ledger-item';
                    const time = new Date(entry.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const dur = Math.round(entry.duration / 60000);
                    li.innerHTML = `
                            <span>${time} - <span class="type-${entry.type}">${entry.type.toUpperCase()}</span></span>
                            <span>${dur} MIN</span>
                        `;
                    list.appendChild(li);
                });

                // Render Chart (Last 7 Days)
                const days = {};
                const now = new Date();
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(now.getDate() - i);
                    days[d.toLocaleDateString()] = 0;
                }

                this.history.forEach(entry => {
                    if (days[entry.date] !== undefined && entry.type === 'focus') {
                        days[entry.date] += entry.duration;
                    }
                });

                const max = Math.max(...Object.values(days), 3600000); // Min 1hr scale
                Object.entries(days).forEach(([date, dur]) => {
                    const bar = document.createElement('div');
                    bar.className = 'chart-bar';
                    const pct = (dur / max) * 100;
                    bar.style.height = pct + '%';
                    bar.dataset.label = `${Math.round(dur / 60000)}m`;
                    chart.appendChild(bar);
                });
            }

            static exportCSV() {
                let csv = "Timestamp,Date,Type,Duration(ms)\n";
                this.history.forEach(e => {
                    csv += `${e.timestamp},${e.date},${e.type},${e.duration}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.setAttribute('hidden', '');
                a.setAttribute('href', url);
                a.setAttribute('download', 'focus_history.csv');
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }

        /**
         * -------------------------------------------------------------------
         * MODULE: HardwareMonitor
         * PURPOSE: Cyber-HUD system sensors.
         * -------------------------------------------------------------------
         */
        class HardwareMonitor {
            static init() {
                this.updateBattery();
                setInterval(() => this.updateBattery(), 30000);
            }

            static async updateBattery() {
                if (!navigator.getBattery) return;
                try {
                    const battery = await navigator.getBattery();
                    const update = () => {
                        const level = Math.round(battery.level * 100);
                        document.getElementById('txtBattery').innerText = level + '%';
                        const bar = document.getElementById('barBattery');
                        bar.style.width = level + '%';

                        // Color logic
                        if (level <= 20) bar.style.background = 'var(--color-state-danger)';
                        else if (level <= 50) bar.style.background = 'var(--color-brand-accent)';
                        else bar.style.background = 'var(--color-state-success)';

                        document.getElementById('iconCharging').style.display = battery.charging ? 'inline' : 'none';
                    };

                    battery.addEventListener('chargingchange', update);
                    battery.addEventListener('levelchange', update);
                    update();
                } catch (e) {
                    Logger.error("Battery API failed");
                }
            }
        }

        /**
         * -------------------------------------------------------------------
         * MODULE: UI
         * PURPOSE: DOM manipulation and state reflection.
         * -------------------------------------------------------------------
         */
        class UI {
            /**
             * Robust Modal Toggling Logic (Fix applied in v5.1)
             * @param {string} id
             */
            static toggleModal(id) {
                const el = document.getElementById('modal-' + id);
                if (!el) return;

                const isOpen = el.classList.contains('state-visible');

                // Close all open modals first
                document.querySelectorAll('.wrapper-modal').forEach(m => {
                    m.classList.remove('state-visible');
                });

                // If target wasn't open, open it now
                if (!isOpen) {
                    el.classList.add('state-visible');
                }
            }

            static toggleRotation() {
                document.body.classList.toggle('mode-landscape');
            }

            static toggleUtils() {
                const el = document.getElementById('navUtils');
                el.classList.toggle('state-expanded');
            }

            static setLayout(type) {
                const b = document.body;

                document.querySelectorAll('#modal-settings .btn-option').forEach(x => {
                    if (x.id.includes('Layout')) x.classList.remove('state-selected');
                });

                if (type === 'uniform') {
                    b.classList.add('layout-uniform');
                    document.getElementById('optLayoutUni').classList.add('state-selected');
                    Storage.set('pref_layout', 'uniform');
                } else {
                    b.classList.remove('layout-uniform');
                    document.getElementById('optLayoutStd').classList.add('state-selected');
                    Storage.set('pref_layout', 'standard');
                }
            }

            static setTheme(theme) {
                const root = document.documentElement;
                root.className = `theme-${theme}`;

                document.querySelectorAll('#modal-settings .btn-option').forEach(x => {
                    if (x.id.includes('Theme')) x.classList.remove('state-selected');
                });

                const btnId = 'optTheme' + theme.charAt(0).toUpperCase() + theme.slice(1);
                const btn = document.getElementById(btnId);
                if (btn) btn.classList.add('state-selected');

                Storage.set('pref_theme', theme);
            }

            static toast(msg) {
                const t = document.getElementById('toast');
                document.getElementById('toastMsg').innerText = msg;
                t.classList.add('state-active');

                // Auto-hide
                setTimeout(() => {
                    t.classList.remove('state-active');
                }, 2500);
            }

            static updateDate() {
                const d = new Date();
                const str = d.toLocaleDateString('en-US', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }).toUpperCase();
                document.getElementById('txtDate').innerText = str;
            }

            static renderFlip(id, val) {
                const el = document.getElementById('card' + id);
                if (!el) return;

                const ts = el.querySelector('.pos-top .text-digit');
                const bs = el.querySelector('.pos-bottom .text-digit');
                const tf = el.querySelector('.layer-flap.pos-top');
                const bf = el.querySelector('.layer-flap.pos-bottom');
                const tfd = tf.querySelector('.text-digit');
                const bfd = bf.querySelector('.text-digit');

                if (val !== ts.innerText) {
                    Sound.playTone();

                    tfd.innerText = ts.innerText;
                    bfd.innerText = val;
                    ts.innerText = val;
                    bs.innerText = ts.innerText;

                    tf.classList.remove('anim-flip-down');
                    bf.classList.remove('anim-flip-up');

                    void tf.offsetWidth; // Force Reflow

                    tf.classList.add('anim-flip-down');
                    bf.classList.add('anim-flip-up');

                    setTimeout(() => {
                        bs.innerText = val;
                        tf.classList.remove('anim-flip-down');
                        bf.classList.remove('anim-flip-up');
                        tfd.innerText = val;
                    }, 600);
                }
            }

            static updateStreak() {
                const t = new Date().toDateString();
                const l = Storage.get('app_last_visit');
                let c = parseInt(Storage.get('app_streak') || 0);

                if (l !== t) {
                    const y = new Date();
                    y.setDate(y.getDate() - 1);
                    if (l === y.toDateString()) {
                        c++;
                    } else {
                        c = 1;
                    }
                    Storage.set('app_last_visit', t);
                    Storage.set('app_streak', c);
                }
                document.getElementById('valStreak').innerText = c;
            }

            static installPWA() {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            document.getElementById('installBtn').style.display = 'none';
                        }
                        deferredPrompt = null;
                    });
                }
            }
        }

        /**
         * -------------------------------------------------------------------
         * MODULE: Engine
         * PURPOSE: Central state management for timekeeping logic.
         * -------------------------------------------------------------------
         */
        class Engine {
            static mode = 'clock';
            static store = {
                clock: {},
                stopwatch: { active: false, start: 0, stored: 0 },
                timer: { active: false, start: 0, stored: 0, total: 300000 },
                pomodoro: { active: false, start: 0, stored: 0, isBreak: false, work: 1500000, break: 300000 },
                ledger: {},
                world: { timezone: 'local' }
            };

            static init() {
                const layout = Storage.get('pref_layout');
                if (layout === 'uniform') UI.setLayout('uniform');

                const theme = Storage.get('pref_theme');
                if (theme) UI.setTheme(theme);

                UI.updateDate();
                UI.updateStreak();
                HardwareMonitor.init();
                SessionLedger.init();
                OLEDProtection.init();
                ParticleSystem.init();
                DigitalVirus.init(); // Initialize Digital Virus (Matrix)
                VoiceControl.init();
                ShakeDetector.init();
                CursorEffect.init();
                this.handleOrientation();
                this.loop();

                // Event Listeners
                window.addEventListener('resize', () => this.handleOrientation());
                document.addEventListener('keydown', e => {
                    if (document.querySelector('.wrapper-modal.state-visible')) return;

                    switch (e.code) {
                        case 'Space': this.toggleState(); break;
                        case 'KeyR': this.resetState(); break;
                        case 'KeyM': Sound.toggle(); break;
                        case 'KeyF': Device.toggleFullscreen(); break;
                        case 'KeyS': UI.toggleModal('settings'); break;
                        case 'Backquote': DevTools.toggle(); break;
                    }
                });
            }

            static loop() {
                if (this.mode === 'clock') this.tickClock();
                if (this.mode === 'stopwatch') this.tickStopwatch();
                if (this.mode === 'timer') this.tickTimer();
                if (this.mode === 'pomodoro') this.tickPomo();

                requestAnimationFrame(() => this.loop());
            }

            static handleOrientation() {
                if (window.matchMedia("(orientation: landscape)").matches) {
                    document.body.classList.add('mode-landscape');
                } else {
                    document.body.classList.remove('mode-landscape');
                }
            }

            static pad(n) { return String(n).padStart(2, '0'); }

            static tickClock() {
                const tz = this.store.world.timezone;
                const n = new Date();

                let h, m, s, ampm;

                if (tz === 'local') {
                    h = n.getHours();
                    m = n.getMinutes();
                    s = n.getSeconds();
                } else {
                    const parts = new Intl.DateTimeFormat('en-US', {
                        timeZone: tz,
                        hour: 'numeric',
                        minute: 'numeric',
                        second: 'numeric',
                        hour12: false
                    }).formatToParts(n);

                    const getPart = (type) => parts.find(p => p.type === type).value;
                    h = parseInt(getPart('hour'));
                    m = parseInt(getPart('minute'));
                    s = parseInt(getPart('second'));
                }

                ampm = h >= 12 ? 'PM' : 'AM';
                const displayH = h % 12 || 12;

                const timeStr = `${this.pad(displayH)}:${this.pad(m)}:${this.pad(s)}`;

                UI.renderFlip('Hours', this.pad(displayH));
                UI.renderFlip('Minutes', this.pad(m));
                UI.renderFlip('Seconds', this.pad(s));

                document.getElementById('lblMeridiem').innerText = ampm;
                PiPService.update(timeStr, 'CLOCK');
            }

            static tickStopwatch() {
                const s = this.store.stopwatch;
                let ms = s.stored + (s.active ? (Date.now() - s.start) : 0);

                const timeStr = `${this.pad(Math.floor(ms / 3600000))}:${this.pad(Math.floor(ms / 60000) % 60)}:${this.pad(Math.floor(ms / 1000) % 60)}`;

                UI.renderFlip('Hours', this.pad(Math.floor(ms / 3600000)));
                UI.renderFlip('Minutes', this.pad(Math.floor(ms / 60000) % 60));
                UI.renderFlip('Seconds', this.pad(Math.floor(ms / 1000) % 60));

                PiPService.update(timeStr, 'STOPWATCH');
            }

            static tickTimer() {
                const s = this.store.timer;
                let rem = s.total - (s.stored + (s.active ? (Date.now() - s.start) : 0));

                if (rem <= 0) {
                    rem = 0;
                    if (s.active) {
                        s.active = false;
                        s.stored = s.total;
                        this.updateUI();
                        SessionLedger.log('focus', s.total);
                        // Trigger Persistent Alarm
                        document.getElementById('alarmTitle').innerText = "TIMER DONE";
                        Sound.startAlarm();
                    }
                }

                const timeStr = `${this.pad(Math.floor(rem / 3600000))}:${this.pad(Math.floor(rem / 60000) % 60)}:${this.pad(Math.ceil(rem / 1000) % 60)}`;

                UI.renderFlip('Hours', this.pad(Math.floor(rem / 3600000)));
                UI.renderFlip('Minutes', this.pad(Math.floor(rem / 60000) % 60));
                UI.renderFlip('Seconds', this.pad(Math.ceil(rem / 1000) % 60));

                PiPService.update(timeStr, 'TIMER');
            }

            static tickPomo() {
                const s = this.store.pomodoro;
                const dur = s.isBreak ? s.break : s.work;
                let rem = dur - (s.stored + (s.active ? (Date.now() - s.start) : 0));

                if (rem <= 0) {
                    rem = 0;
                    if (s.active) {
                        const completedType = s.isBreak ? 'break' : 'focus';
                        const completedDuration = s.isBreak ? s.break : s.work;
                        SessionLedger.log(completedType, completedDuration);

                        s.active = false;
                        s.stored = 0;
                        s.isBreak = !s.isBreak;
                        this.updateUI();
                        // Trigger Persistent Alarm
                        const msg = s.isBreak ? "Break Over!" : "Focus Complete!";
                        document.getElementById('alarmTitle').innerText = msg;
                        Sound.startAlarm();

                        UI.toast(msg);
                    }
                }

                const timeStr = `${this.pad(Math.floor(rem / 60000) % 60)}:${this.pad(Math.ceil(rem / 1000) % 60)}`;

                UI.renderFlip('Hours', this.pad(Math.floor(rem / 3600000)));
                UI.renderFlip('Minutes', this.pad(Math.floor(rem / 60000) % 60));
                UI.renderFlip('Seconds', this.pad(Math.ceil(rem / 1000) % 60));

                const b = document.getElementById('badgePomo');
                b.className = s.isBreak ? "badge-status variant-break" : "badge-status variant-focus";
                b.innerHTML = s.isBreak ?
                    `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path></svg> BREAK MODE` :
                    `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> FOCUS MODE`;

                PiPService.update(timeStr, s.isBreak ? 'BREAK' : 'FOCUS');
            }

            static setMode(m) {
                this.mode = m;
                document.querySelectorAll('.btn-nav').forEach(b => b.classList.remove('active'));
                document.querySelector(`.btn-nav[data-view="${m}"]`).classList.add('active');

                const bar = document.getElementById('actionBar');
                const mer = document.getElementById('lblMeridiem');
                const badge = document.getElementById('badgePomo');
                const mainView = document.getElementById('view-main');
                const ledgerView = document.getElementById('view-ledger');
                const worldView = document.getElementById('view-world');

                // Reset views
                mainView.style.display = 'none';
                ledgerView.classList.remove('state-active');
                worldView.classList.remove('state-active');

                if (m === 'ledger') {
                    ledgerView.classList.add('state-active');
                    SessionLedger.render();
                    bar.classList.remove('state-visible');
                    mer.style.opacity = 0;
                    badge.style.display = 'none';
                } else if (m === 'world') {
                    worldView.classList.add('state-active');
                    WorldClock.render();
                    bar.classList.remove('state-visible');
                    mer.style.opacity = 0;
                    badge.style.display = 'none';
                } else {
                    mainView.style.display = 'contents';
                    if (m === 'clock') {
                        bar.classList.remove('state-visible');
                        mer.style.opacity = 0.6;
                        badge.style.display = 'none';
                    } else {
                        bar.classList.add('state-visible');
                        mer.style.opacity = 0;
                        badge.style.display = (m === 'pomodoro') ? 'inline-flex' : 'none';

                        const st = this.store[m];
                        if (!st.active && st.stored === 0) {
                            if (m === 'stopwatch') {
                                UI.renderFlip('Hours', '00'); UI.renderFlip('Minutes', '00'); UI.renderFlip('Seconds', '00');
                            } else if (m === 'timer') {
                                let d = st.total;
                                UI.renderFlip('Hours', this.pad(Math.floor(d / 3600000)));
                                UI.renderFlip('Minutes', this.pad(Math.floor(d / 60000) % 60));
                                UI.renderFlip('Seconds', '00');
                            } else if (m === 'pomodoro') {
                                let d = st.work;
                                UI.renderFlip('Hours', this.pad(Math.floor(d / 3600000)));
                                UI.renderFlip('Minutes', this.pad(Math.floor(d / 60000) % 60));
                                UI.renderFlip('Seconds', '00');
                            }
                        }
                    }
                }
                this.updateUI();
            }

            static updateUI() {
                if (this.mode === 'clock') return;
                const st = this.store[this.mode];
                const btn = document.getElementById('btnMain');
                const edit = document.getElementById('btnEdit');

                btn.innerText = st.active ? "PAUSE" : "START";
                btn.className = st.active ? "btn-pill" : "btn-pill variant-primary";

                edit.style.display = (this.mode === 'timer') ? 'block' : 'none';
            }

            static toggleState() {
                const st = this.store[this.mode];
                if (st.active) {
                    st.active = false;
                    st.stored += Date.now() - st.start;
                } else {
                    st.active = true;
                    st.start = Date.now();
                    Device.requestWakeLock();
                }
                this.updateUI();
            }

            static resetState() {
                const st = this.store[this.mode];
                st.active = false;
                st.stored = 0;

                if (this.mode === 'pomodoro') st.isBreak = false;

                this.updateUI();

                if (this.mode === 'stopwatch') {
                    UI.renderFlip('Hours', '00');
                    UI.renderFlip('Minutes', '00');
                    UI.renderFlip('Seconds', '00');
                } else if (this.mode === 'timer') {
                    let d = st.total;
                    UI.renderFlip('Minutes', this.pad(Math.floor(d / 60000)));
                    UI.renderFlip('Seconds', '00');
                } else if (this.mode === 'pomodoro') {
                    let d = st.work;
                    UI.renderFlip('Minutes', this.pad(Math.floor(d / 60000)));
                    UI.renderFlip('Seconds', '00');
                    document.getElementById('badgePomo').className = "badge-status variant-focus";
                }
            }

            static editState() {
                const m = prompt("Set Timer (Minutes):", "5");
                if (m && !isNaN(m) && m > 0) {
                    const st = this.store.timer;
                    st.active = false;
                    st.stored = 0;
                    st.total = Math.floor(parseFloat(m) * 60000);
                    this.resetState();
                }
            }
        }

        // --- APP BOOTSTRAP ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').style.display = 'flex';
        });

        window.addEventListener('DOMContentLoaded', () => {
            Logger.log("Initializing Titanium Core v8.0...");
            Engine.init();

            const unlock = () => {
                Sound.init();
                document.removeEventListener('click', unlock);
            };
            document.addEventListener('click', unlock);

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible' && (Engine.store.timer.active || Engine.store.stopwatch.active)) {
                    Device.requestWakeLock();
                }
            });
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => Logger.log('ServiceWorker Registered'))
                    .catch(err => {
                        // ServiceWorker file not found - this is expected in development
                        // Gracefully continue without offline support
                        console.log('ServiceWorker not available (expected in development)');
                    });
            });
        }
    </script>
</body>

</html>
